var Kr=Object.defineProperty;var Hr=(ce,K,le)=>K in ce?Kr(ce,K,{enumerable:!0,configurable:!0,writable:!0,value:le}):ce[K]=le;var d=(ce,K,le)=>(Hr(ce,typeof K!="symbol"?K+"":K,le),le);(function(){"use strict";function ce(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var K={exports:{}};(function(t){var s=Object.prototype.hasOwnProperty,e="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(e=!1));function n(u,c,l){this.fn=u,this.context=c,this.once=l||!1}function r(u,c,l,h,p){if(typeof l!="function")throw new TypeError("The listener must be a function");var f=new n(l,h||u,p),g=e?e+c:c;return u._events[g]?u._events[g].fn?u._events[g]=[u._events[g],f]:u._events[g].push(f):(u._events[g]=f,u._eventsCount++),u}function a(u,c){--u._eventsCount===0?u._events=new i:delete u._events[c]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var c=[],l,h;if(this._eventsCount===0)return c;for(h in l=this._events)s.call(l,h)&&c.push(e?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},o.prototype.listeners=function(c){var l=e?e+c:c,h=this._events[l];if(!h)return[];if(h.fn)return[h.fn];for(var p=0,f=h.length,g=new Array(f);p<f;p++)g[p]=h[p].fn;return g},o.prototype.listenerCount=function(c){var l=e?e+c:c,h=this._events[l];return h?h.fn?1:h.length:0},o.prototype.emit=function(c,l,h,p,f,g){var m=e?e+c:c;if(!this._events[m])return!1;var b=this._events[m],v=arguments.length,T,w;if(b.fn){switch(b.once&&this.removeListener(c,b.fn,void 0,!0),v){case 1:return b.fn.call(b.context),!0;case 2:return b.fn.call(b.context,l),!0;case 3:return b.fn.call(b.context,l,h),!0;case 4:return b.fn.call(b.context,l,h,p),!0;case 5:return b.fn.call(b.context,l,h,p,f),!0;case 6:return b.fn.call(b.context,l,h,p,f,g),!0}for(w=1,T=new Array(v-1);w<v;w++)T[w-1]=arguments[w];b.fn.apply(b.context,T)}else{var x=b.length,_;for(w=0;w<x;w++)switch(b[w].once&&this.removeListener(c,b[w].fn,void 0,!0),v){case 1:b[w].fn.call(b[w].context);break;case 2:b[w].fn.call(b[w].context,l);break;case 3:b[w].fn.call(b[w].context,l,h);break;case 4:b[w].fn.call(b[w].context,l,h,p);break;default:if(!T)for(_=1,T=new Array(v-1);_<v;_++)T[_-1]=arguments[_];b[w].fn.apply(b[w].context,T)}}return!0},o.prototype.on=function(c,l,h){return r(this,c,l,h,!1)},o.prototype.once=function(c,l,h){return r(this,c,l,h,!0)},o.prototype.removeListener=function(c,l,h,p){var f=e?e+c:c;if(!this._events[f])return this;if(!l)return a(this,f),this;var g=this._events[f];if(g.fn)g.fn===l&&(!p||g.once)&&(!h||g.context===h)&&a(this,f);else{for(var m=0,b=[],v=g.length;m<v;m++)(g[m].fn!==l||p&&!g[m].once||h&&g[m].context!==h)&&b.push(g[m]);b.length?this._events[f]=b.length===1?b[0]:b:a(this,f)}return this},o.prototype.removeAllListeners=function(c){var l;return c?(l=e?e+c:c,this._events[l]&&a(this,l)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=e,o.EventEmitter=o,t.exports=o})(K);var le=K.exports;function Ut(t=16,s="abcdefghijklmnopqrstuvwxyz0123456789"){let e="";const i=s.length;for(let n=0;n<t;n++)e+=s.charAt(Math.floor(Math.random()*i));return e}function Zt(t){return t.match(/([^:]*):(.*)/).slice(1,3)}function Tn(t,s=!1,e=","){if(isNaN(t)||t===null)return null;const i=t<0?"-":"";t=Math.abs(t);const n=Math.floor(t/1e3/86400),r=Math.floor(t/1e3%86400/3600),a=Math.floor(t/1e3%3600/60),o=Math.floor(t/1e3%3600%60);let u="";return u+=(!s||!u.length)&&n>0?(u.length?`${e} `:"")+i+n+"d":"",u+=(!s||!u.length)&&r>0?(u.length?`${e} `:"")+i+r+"h":"",u+=(!s||!u.length)&&a>0?(u.length?`${e} `:"")+i+a+"m":"",u+=(!s||!u.length)&&o>0?(u.length?`${e} `:"")+i+o+"s":"",(!u.length||!s&&t<60*1e3&&t>o*1e3)&&(u+=(u.length?`${e} `:"")+i+(t-o*1e3)+"ms"),u.trim()}function je(t=1e3){return new Promise(s=>{setTimeout(()=>s(),t)})}function En(t){const s=Ut(8);return new Promise(e=>{const i=({data:n})=>{n.trackingId===t.trackingId&&(self.removeEventListener("message",i),e(n.data))};self.addEventListener("message",i),t.trackingId=s,self.postMessage(t)})}var N={calculateSlippage:null,aggregationLength:null,preferQuoteCurrencySize:null,wsProxyUrl:null,buckets:{}};class P extends le.EventEmitter{constructor(){super();d(this,"id");d(this,"pairs",[]);d(this,"products",null);d(this,"delayBetweenMessages");d(this,"maxConnectionsPerApi");d(this,"endpoints");d(this,"keepAliveIntervals",{});d(this,"apis",[]);d(this,"connecting",{});d(this,"disconnecting",{});d(this,"scheduledOperations",{});d(this,"scheduledOperationsDelays",{});d(this,"clearReconnectionDelayTimeout",{});d(this,"count",0)}get requiresProducts(){return!this.products&&this.endpoints.PRODUCTS}isMatching(e){return!this.products||!this.products.length?(console.debug(`[${this.id}.isMatching] couldn't match ${e}, exchange has no products`),!1):this.products.indexOf(e)===-1?(console.debug(`[${this.id}.isMatching] couldn't match ${e}`),!1):!0}getUrl(e){throw new Error("Not implemented")}async link(e,i){if(e=e.replace(/[^:]*:/,""),!this.isMatching(e))return Promise.reject(`${this.id} couldn't match with ${e}`);console.debug(`[${this.id}.link] linking ${e}`),this.resolveApi(e,i)}async resolveApi(e,i){const n=await this.getUrl(e);let r;N.wsProxyUrl&&i?r=N.wsProxyUrl+n:r=n;let a=this.getActiveApiByUrl(r);if(a||(a=this.createWs(r,e)),a._wasErrored=i,a._originalUrl=n,a._pending.indexOf(e)!==-1){console.warn(`[${this.id}.resolveApi] ${e}'s api is already connecting to ${e}`);return}if(a._connected.indexOf(e)!==-1){console.warn(`[${this.id}.resolveApi] ${e}'s api is already connected to ${e}`);return}if(a._pending.push(e),a.readyState===WebSocket.OPEN){const o="subscribe-"+a._id;clearTimeout(this.scheduledOperations[o]),this.scheduledOperations[o]=setTimeout(()=>{delete this.scheduledOperations[o],this.subscribePendingPairs(a)},1e3)}return a}createWs(e,i){const n=new WebSocket(e);return n._id=Ut(),console.debug(`[${this.id}] initiate new ws connection ${e} (${n._id}) for pair ${i}`),n.binaryType="arraybuffer",n._connected=[],n._pending=[],this.apis.push(n),n.onmessage=r=>{this.count++,this.onMessage(r,n)===!0&&(n._timestamp=Date.now())},n.onopen=r=>{n._wasOpened=!0,typeof this.scheduledOperationsDelays[e]<"u"&&(this.clearReconnectionDelayTimeout[e]=setTimeout(()=>{delete this.clearReconnectionDelayTimeout[e],console.debug(`[${this.id}.createWs] clear reconnection delay (${e})`),delete this.scheduledOperationsDelays[e],n._reconnecting=!1},1e4)),this.markLoadingAsCompleted(this.connecting,n._id,!0),this.subscribePendingPairs(n),this.onOpen(r,n._connected)},n.onclose=async r=>{this.clearReconnectionDelayTimeout[e]&&(clearTimeout(this.clearReconnectionDelayTimeout[e]),delete this.clearReconnectionDelayTimeout[e]),this.markLoadingAsCompleted(this.connecting,n._id,!1),this.onClose(r,n._connected),this.markLoadingAsCompleted(this.disconnecting,n._id,!0);const a=[...n._pending,...n._connected];a.length?(console.error(`[${this.id}] connection closed unexpectedly, schedule reconnection (${a.join(",")})`),setTimeout(()=>{this.reconnectApi(n)},this.getTimeoutDelay(n.url))):this.removeWs(n)},n.onerror=r=>{n._errored=!0,console.debug(`[${this.id}.onError] ${r.target._connected.join(",")}'s api errored`,r),this.onError(r)},this.connecting[n._id]={},this.connecting[n._id].promise=new Promise((r,a)=>{this.connecting[n._id].resolver=o=>{o?(this.onApiCreated(n),r(n)):a()}}),n}async subscribePendingPairs(e){console.debug(`[${this.id}.subscribePendingPairs] subscribe to ${e._pending.length} pairs of api ${e.url} (${e._pending.join(", ")})`);const i=e._pending.slice();for(const n of i)await this.subscribe(e,n)}async unlink(e){e=e.replace(/[^:]*:/,"");const i=this.getActiveApiByPair(e);if(i){if(i._connected.indexOf(e)===-1){const n=i._pending.indexOf(e);n!==-1?(console.debug(`[${this.id}.unlink] remove "${e}" from ${i._id}'s pending pairs`),i._pending.splice(n,1)):console.debug(`[${this.id}.unlink] "${e}" does not exist on exchange ${this.id} (resolved immediately)`);return}if(console.debug(`[${this.id}.unlink] unlinking ${e}`),await this.unsubscribe(i,e),!i._connected.length)return console.debug(`[${this.id}.unlink] ${e}'s api is now empty (trigger close api)`),this.removeWs(i)}}getActiveApiByPair(e){for(let i=0;i<this.apis.length;i++)if(this.apis[i]._connected.indexOf(e)!==-1||this.apis[i]._pending.indexOf(e)!==-1)return this.apis[i]}getActiveApiByUrl(e){for(let i=0;i<this.apis.length;i++)if(this.apis[i].readyState<2&&this.apis[i]._originalUrl===e&&(!this.maxConnectionsPerApi||this.apis[i]._connected.length+this.apis[i]._pending.length<this.maxConnectionsPerApi))return this.apis[i]}removeWs(e){let i;if(e.readyState!==WebSocket.CLOSED){if(e._connected.length)throw new Error("Cannot unbind api that still has pairs linked to it");console.debug(`[${this.id}.removeWs] close api ${e.url}`),this.disconnecting[e._id]={},this.disconnecting[e._id].promise=new Promise((n,r)=>{e.readyState<WebSocket.CLOSING&&e.close(),this.disconnecting[e._id].resolver=a=>a?n():r()}),i=this.disconnecting[e._id].promise}else i=Promise.resolve();return i.then(()=>{console.debug(`[${this.id}] remove api ${e.url}`),this.onApiRemoved(e),this.apis.splice(this.apis.indexOf(e),1)})}reconnectApi(e){console.debug(`[${this.id}.reconnectApi] reconnect api (url: ${e.url}, _connected: ${e._connected.join(", ")}, _pending: ${e._connected.join(", ")}, readyState: ${e.readyState})`);const i=[...e._pending,...e._connected];this.removeWs(e),this.reconnectPairs(i,e._errored)}async reconnectPairs(e,i){const n=e.slice(0,e.length);console.info(`[${this.id}.reconnectPairs] reconnect pairs ${n.join(",")}`);for(const r of n)console.debug(`[${this.id}.reconnectPairs] unlinking market ${this.id+":"+r}`),await this.unlink(this.id+":"+r);await new Promise(r=>setTimeout(r,500));for(const r of n)console.debug(`[${this.id}.reconnectPairs] linking market ${this.id+":"+r}`),await this.link(this.id+":"+r,i)}setProducts(e){if(!e)return console.debug(`[${this.id}] set products with no data (setting null)`),this.products=null,null;if(!this.validateProducts(e))return this.products=null,!1;if(typeof e=="object"&&Object.prototype.hasOwnProperty.call(e,"products")){console.debug(`[${this.id}] set products (products data)`);for(const i in e)this[i]=e[i]}else Array.isArray(e)&&(console.debug(`[${this.id}] set products (array of markets)`),this.products=e);return!0}async getProducts(e){if(console.debug(`[${this.id}] request product ${e?"(force fetching)":""}`),!this.endpoints.PRODUCTS)return this.products;const i=await En({op:"getExchangeProducts",data:{exchangeId:this.id,endpoints:this.endpoints.PRODUCTS,forceFetch:e}});return this.setProducts(i.data)===!1?this.getProducts(!0):i.data}onOpen(e,i){console.debug(`[${this.id}.onOpen] ${i.join(",")}'s api connected`),this.emit("open",e)}onApiCreated(e){}onApiRemoved(e){}onMessage(e,i){throw new Error("Not implemented")}onError(e){this.emit("error",e)}onClose(e,i){console.debug(`[${this.id}] ${i.join(",")}'s api closed`),this.emit("close",e)}formatProducts(e){return e}validateProducts(e){return!0}async subscribe(e,i){return!this.markPairAsConnected(e,i)||(this.emit("subscribed",i,e.url),e.readyState!==WebSocket.OPEN)?!1:(this.delayBetweenMessages&&await je(this.delayBetweenMessages*this.apis.length),!0)}async unsubscribe(e,i){return!this.markPairAsDisconnected(e,i)||(this.emit("unsubscribed",i,e._id),e.readyState!==WebSocket.OPEN)?!1:(this.delayBetweenMessages&&await je(this.delayBetweenMessages*this.apis.length),e.readyState===WebSocket.OPEN)}emitTrades(e,i){if(!(!i||!i.length))return this.emit("trades",i),!0}emitLiquidations(e,i){if(!(!i||!i.length))return this.emit("liquidations",i),!0}startKeepAlive(e,i={event:"ping"},n=3e4){this.keepAliveIntervals[e.url]&&this.stopKeepAlive(e),this.keepAliveIntervals[e.url]=setInterval(()=>{e.readyState===WebSocket.OPEN&&e.send(typeof i=="string"?i:JSON.stringify(i))},n)}stopKeepAlive(e){this.keepAliveIntervals[e.url]&&(console.debug(`[${this.id}] stop keepalive for ws ${e.url}`),clearInterval(this.keepAliveIntervals[e.url]),delete this.keepAliveIntervals[e.url])}markLoadingAsCompleted(e,i,n){e[i]&&(e[i].resolver(n),delete e[i])}getTimeoutDelay(e,i=1e3){const n=Math.max(i,this.scheduledOperationsDelays[e]||0);return this.scheduledOperationsDelays[e]=n*1.5,n}markPairAsConnected(e,i){const n=e._pending.indexOf(i);if(n!==-1)e._pending.splice(n,1);else return console.warn(`[${this.id}.markPairAsConnected] ${i} appears to be NOT connecting anymore (prevent undesired subscription)`),!1;return e._connected.indexOf(i)!==-1?(console.debug(`[${this.id}.markPairAsConnected] ${i} is already in the _connected list (prevent double subscription)`),!1):(e._connected.push(i),!0)}markPairAsDisconnected(e,i){const n=e._pending.indexOf(i);if(n!==-1)return console.debug(`[${this.id}.markPairAsDisconnected] ${i} was NOT yet connected to api (prevent unsubscription of non connected pair)`),e._pending.splice(n,1),!1;const r=e._connected.indexOf(i);return r===-1?(console.debug(`[${this.id}.markPairAsDisconnected] ${i} was NOT found in in the _connected list (prevent double unsubscription)`),!1):(e._connected.splice(r,1),!0)}getEstimatedTimeToConnect(e){if(!this.delayBetweenMessages)return e;const i=e*this.delayBetweenMessages,n=Math.ceil(e/this.maxConnectionsPerApi);return this.maxConnectionsPerApi&&e>this.maxConnectionsPerApi?i/Math.ceil(e/this.maxConnectionsPerApi)*n:i}}class On extends P{constructor(){super(...arguments);d(this,"id","AGGR");d(this,"endpoints",{});d(this,"products",["SENTIMENTTV","SENTIMENTMEX"])}async getUrl(){return"wss://sentiment.aggr.trade"}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({op:"SUBSCRIBE",channel:i})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({op:"UNSUBSCRIBE",channel:i})),!0}formatTrade(e,i){return{exchange:this.id,pair:i,timestamp:+e.timestamp,price:+e.price,size:+e.volume,side:e.side}}onMessage(e,i){const n=JSON.parse(e.data);return this.emitTrades(i.id,[this.formatTrade(n.data,n.channel)])}}class An extends P{constructor(){super(...arguments);d(this,"id","BITMEX");d(this,"xbtPrice",48e3);d(this,"types");d(this,"multipliers");d(this,"underlyingToPositionMultipliers");d(this,"endpoints",{PRODUCTS:"https://www.bitmex.com/api/v1/instrument/active"})}async getUrl(){return"wss://www.bitmex.com/realtime"}formatProducts(e){const i=[],n={},r={},a={};for(const o of e)n[o.symbol]=o.isInverse?"inverse":o.isQuanto?"quanto":"linear",r[o.symbol]=o.multiplier,n[o.symbol]==="linear"&&(a[o.symbol]=o.underlyingToPositionMultiplier),i.push(o.symbol);return{products:i,types:n,multipliers:r,underlyingToPositionMultipliers:a}}validateProducts(e){return!(!e||!e.multipliers||!e.underlyingToPositionMultipliers||!e.types)}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({op:"subscribe",args:["trade:"+i,"liquidation:"+i]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({op:"unsubscribe",args:["trade:"+i,"liquidation:"+i]})),!0}onApiCreated(e){e.send(JSON.stringify({op:"subscribe",args:["instrument:XBTUSD"]}))}onMessage(e,i){const n=JSON.parse(e.data);if(n&&n.data&&n.data.length){if(n.table==="liquidation"&&n.action==="insert")return this.emitLiquidations(i.id,n.data.map(r=>{let a;return this.types[r.symbol]==="quanto"?a=this.multipliers[r.symbol]/1e8*r.leavesQty*this.xbtPrice:this.types[r.symbol]==="inverse"?a=r.leavesQty/r.price:a=1/this.underlyingToPositionMultipliers[r.symbol]*r.leavesQty,{exchange:this.id,pair:r.symbol,timestamp:Date.now(),price:r.price,size:a,side:r.side==="Buy"?"buy":"sell",liquidation:!0}}));if(n.table==="trade"&&n.action==="insert")return this.emitTrades(i.id,n.data.map(r=>({exchange:this.id,pair:r.symbol,timestamp:+new Date(r.timestamp),price:r.price,size:r.homeNotional,side:r.side==="Buy"?"buy":"sell"})));n.table==="instrument"&&n.data[0].lastPrice&&(this.xbtPrice=n.data[0].lastPrice)}}}class Cn extends P{constructor(){super(...arguments);d(this,"id","BINANCE_FUTURES");d(this,"lastSubscriptionId",0);d(this,"subscriptions",{});d(this,"specs");d(this,"dapi");d(this,"maxConnectionsPerApi",100);d(this,"delayBetweenMessages",100);d(this,"endpoints",{PRODUCTS:["https://fapi.binance.com/fapi/v1/exchangeInfo","https://dapi.binance.com/dapi/v1/exchangeInfo"]})}async getUrl(e){return this.dapi[e]?"wss://dstream.binance.com/ws":"wss://fstream.binance.com/ws"}formatProducts(e){const i=[],n={},r={};for(const a of e){const o=["fapi","dapi"][e.indexOf(a)];for(const u of a.symbols){if(u.contractStatus&&u.contractStatus!=="TRADING"||u.status&&u.status!=="TRADING")continue;const c=u.symbol.toLowerCase();o==="dapi"&&(r[c]=!0),u.contractSize&&(n[c]=u.contractSize),i.push(c)}}return{products:i,specs:n,dapi:r}}async subscribe(e,i){if(!await super.subscribe(e,i))return;this.subscriptions[i]=++this.lastSubscriptionId;const n=N.aggregationLength===-1?"trade":"aggTrade",r=[i+"@"+n,i+"@forceOrder"];return e.send(JSON.stringify({method:"SUBSCRIBE",params:r,id:this.subscriptions[i]})),await je(250*this.apis.length),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;const n=N.aggregationLength===-1?"trade":"aggTrade",r=[i+"@"+n,i+"@forceOrder"];return e.send(JSON.stringify({method:"UNSUBSCRIBE",params:r,id:this.subscriptions[i]})),delete this.subscriptions[i],!0}onMessage(e,i){const n=JSON.parse(e.data);if(n){if(n.T&&n.X!=="INSURANCE_FUND"){let r=+n.q;const a=n.s.toLowerCase();return typeof this.specs[a]=="number"&&(r=r*this.specs[a]/n.p),this.emitTrades(i.id,[{exchange:this.id,pair:a,timestamp:n.T,price:+n.p,size:r,side:n.m?"sell":"buy",count:n.l-n.f+1}])}else if(n.e==="forceOrder"){let r=+n.o.q;const a=n.o.s.toLowerCase();return typeof this.specs[a]=="number"&&(r=r*this.specs[a]/n.o.p),this.emitLiquidations(i.id,[{exchange:this.id,pair:a,timestamp:n.o.T,price:+n.o.p,size:r,side:n.o.S==="BUY"?"buy":"sell",liquidation:!0}])}}else return}}class Nn extends P{constructor(){super(...arguments);d(this,"id","BINANCE_US");d(this,"lastSubscriptionId",0);d(this,"subscriptions",{});d(this,"endpoints",{PRODUCTS:"https://api.binance.us/api/v3/exchangeInfo"})}async getUrl(){return"wss://stream.binance.us:9443/ws"}formatProducts(e){return e.symbols.filter(i=>i.status==="TRADING").map(i=>i.symbol.toLowerCase())}async subscribe(e,i){if(!await super.subscribe(e,i))return;this.subscriptions[i]=++this.lastSubscriptionId;const n=[i+"@trade"];return e.send(JSON.stringify({method:"SUBSCRIBE",params:n,id:this.subscriptions[i]})),await je(250),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;const n=[i+"@trade"];return e.send(JSON.stringify({method:"UNSUBSCRIBE",params:n,id:this.subscriptions[i]})),delete this.subscriptions[i],new Promise(r=>setTimeout(r,250))}onMessage(e,i){const n=JSON.parse(e.data);if(n.E)return this.emitTrades(i.id,[{exchange:this.id,pair:n.s.toLowerCase(),timestamp:n.E,price:+n.p,size:+n.q,side:n.m?"sell":"buy"}])}}class Pn extends P{constructor(){super(...arguments);d(this,"id","KRAKEN");d(this,"specs");d(this,"isPFregex",/^PF_/);d(this,"endpoints",{PRODUCTS:["https://api.kraken.com/0/public/AssetPairs","https://futures.kraken.com/derivatives/api/v3/instruments"]})}async getUrl(e){return typeof this.specs[e]<"u"?"wss://futures.kraken.com/ws/v1":"wss://ws.kraken.com/"}formatProducts(e){const i=[],n={};for(const r of e)if(r.instruments)for(const a of r.instruments){if(!a.tradeable)continue;const o=a.symbol.toUpperCase();n[o]=a.contractSize,i.push(o)}else if(r.result)for(const a in r.result)r.result[a].wsname&&i.push(r.result[a].wsname);return{products:i,specs:n}}async subscribe(e,i){if(!await super.subscribe(e,i))return;const n={event:"subscribe"};return typeof this.specs[i]<"u"?(n.product_ids=[i],n.feed="trade"):(n.pair=[i],n.subscription={name:"trade"}),e.send(JSON.stringify(n)),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;const n={event:"unsubscribe"};return typeof this.specs[i]<"u"?(n.product_ids=[i],n.feed="trade"):(n.pair=[i],n.subscription={name:"trade"}),e.send(JSON.stringify(n)),!0}onMessage(e,i){const n=JSON.parse(e.data);if(!(!n||n.event==="heartbeat"))return n.feed==="trade"&&n.qty?this.emitTrades(i.id,[{exchange:this.id,pair:n.product_id,timestamp:n.time,price:n.price,size:this.isPFregex.test(n.product_id)?n.qty:n.qty/n.price,side:n.side}]):n[1]&&n[1].length?this.emitTrades(i.id,n[1].map(r=>({exchange:this.id,pair:n[3],timestamp:r[2]*1e3,price:+r[0],size:+r[1],side:r[3]==="b"?"buy":"sell"}))):!1}onApiCreated(e){/futures/.test(e.url)&&this.startKeepAlive(e)}onApiRemoved(e){/futures/.test(e.url)&&this.stopKeepAlive(e)}}var Q={};(function(t){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";function e(r,a){return Object.prototype.hasOwnProperty.call(r,a)}t.assign=function(r){for(var a=Array.prototype.slice.call(arguments,1);a.length;){var o=a.shift();if(o){if(typeof o!="object")throw new TypeError(o+"must be non-object");for(var u in o)e(o,u)&&(r[u]=o[u])}}return r},t.shrinkBuf=function(r,a){return r.length===a?r:r.subarray?r.subarray(0,a):(r.length=a,r)};var i={arraySet:function(r,a,o,u,c){if(a.subarray&&r.subarray){r.set(a.subarray(o,o+u),c);return}for(var l=0;l<u;l++)r[c+l]=a[o+l]},flattenChunks:function(r){var a,o,u,c,l,h;for(u=0,a=0,o=r.length;a<o;a++)u+=r[a].length;for(h=new Uint8Array(u),c=0,a=0,o=r.length;a<o;a++)l=r[a],h.set(l,c),c+=l.length;return h}},n={arraySet:function(r,a,o,u,c){for(var l=0;l<u;l++)r[c+l]=a[o+l]},flattenChunks:function(r){return[].concat.apply([],r)}};t.setTyped=function(r){r?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,i)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,n))},t.setTyped(s)})(Q);var Ae={},H={},ve={},In=Q,zn=4,Jt=0,Ft=1,Dn=2;function we(t){for(var s=t.length;--s>=0;)t[s]=0}var $n=0,jt=1,Rn=2,Bn=3,Mn=258,ft=29,Ce=256,Ne=Ce+1+ft,ye=30,ht=19,qt=2*Ne+1,ue=15,pt=16,Ln=7,bt=256,Kt=16,Ht=17,Gt=18,_t=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],qe=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Un=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Wt=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Zn=512,V=new Array((Ne+2)*2);we(V);var Pe=new Array(ye*2);we(Pe);var Ie=new Array(Zn);we(Ie);var ze=new Array(Mn-Bn+1);we(ze);var gt=new Array(ft);we(gt);var Ke=new Array(ye);we(Ke);function mt(t,s,e,i,n){this.static_tree=t,this.extra_bits=s,this.extra_base=e,this.elems=i,this.max_length=n,this.has_stree=t&&t.length}var Xt,Yt,Qt;function vt(t,s){this.dyn_tree=t,this.max_code=0,this.stat_desc=s}function Vt(t){return t<256?Ie[t]:Ie[256+(t>>>7)]}function De(t,s){t.pending_buf[t.pending++]=s&255,t.pending_buf[t.pending++]=s>>>8&255}function M(t,s,e){t.bi_valid>pt-e?(t.bi_buf|=s<<t.bi_valid&65535,De(t,t.bi_buf),t.bi_buf=s>>pt-t.bi_valid,t.bi_valid+=e-pt):(t.bi_buf|=s<<t.bi_valid&65535,t.bi_valid+=e)}function G(t,s,e){M(t,e[s*2],e[s*2+1])}function ei(t,s){var e=0;do e|=t&1,t>>>=1,e<<=1;while(--s>0);return e>>>1}function Jn(t){t.bi_valid===16?(De(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=t.bi_buf&255,t.bi_buf>>=8,t.bi_valid-=8)}function Fn(t,s){var e=s.dyn_tree,i=s.max_code,n=s.stat_desc.static_tree,r=s.stat_desc.has_stree,a=s.stat_desc.extra_bits,o=s.stat_desc.extra_base,u=s.stat_desc.max_length,c,l,h,p,f,g,m=0;for(p=0;p<=ue;p++)t.bl_count[p]=0;for(e[t.heap[t.heap_max]*2+1]=0,c=t.heap_max+1;c<qt;c++)l=t.heap[c],p=e[e[l*2+1]*2+1]+1,p>u&&(p=u,m++),e[l*2+1]=p,!(l>i)&&(t.bl_count[p]++,f=0,l>=o&&(f=a[l-o]),g=e[l*2],t.opt_len+=g*(p+f),r&&(t.static_len+=g*(n[l*2+1]+f)));if(m!==0){do{for(p=u-1;t.bl_count[p]===0;)p--;t.bl_count[p]--,t.bl_count[p+1]+=2,t.bl_count[u]--,m-=2}while(m>0);for(p=u;p!==0;p--)for(l=t.bl_count[p];l!==0;)h=t.heap[--c],!(h>i)&&(e[h*2+1]!==p&&(t.opt_len+=(p-e[h*2+1])*e[h*2],e[h*2+1]=p),l--)}}function ti(t,s,e){var i=new Array(ue+1),n=0,r,a;for(r=1;r<=ue;r++)i[r]=n=n+e[r-1]<<1;for(a=0;a<=s;a++){var o=t[a*2+1];o!==0&&(t[a*2]=ei(i[o]++,o))}}function jn(){var t,s,e,i,n,r=new Array(ue+1);for(e=0,i=0;i<ft-1;i++)for(gt[i]=e,t=0;t<1<<_t[i];t++)ze[e++]=i;for(ze[e-1]=i,n=0,i=0;i<16;i++)for(Ke[i]=n,t=0;t<1<<qe[i];t++)Ie[n++]=i;for(n>>=7;i<ye;i++)for(Ke[i]=n<<7,t=0;t<1<<qe[i]-7;t++)Ie[256+n++]=i;for(s=0;s<=ue;s++)r[s]=0;for(t=0;t<=143;)V[t*2+1]=8,t++,r[8]++;for(;t<=255;)V[t*2+1]=9,t++,r[9]++;for(;t<=279;)V[t*2+1]=7,t++,r[7]++;for(;t<=287;)V[t*2+1]=8,t++,r[8]++;for(ti(V,Ne+1,r),t=0;t<ye;t++)Pe[t*2+1]=5,Pe[t*2]=ei(t,5);Xt=new mt(V,_t,Ce+1,Ne,ue),Yt=new mt(Pe,qe,0,ye,ue),Qt=new mt(new Array(0),Un,0,ht,Ln)}function ii(t){var s;for(s=0;s<Ne;s++)t.dyn_ltree[s*2]=0;for(s=0;s<ye;s++)t.dyn_dtree[s*2]=0;for(s=0;s<ht;s++)t.bl_tree[s*2]=0;t.dyn_ltree[bt*2]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function ni(t){t.bi_valid>8?De(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function qn(t,s,e,i){ni(t),i&&(De(t,e),De(t,~e)),In.arraySet(t.pending_buf,t.window,s,e,t.pending),t.pending+=e}function si(t,s,e,i){var n=s*2,r=e*2;return t[n]<t[r]||t[n]===t[r]&&i[s]<=i[e]}function wt(t,s,e){for(var i=t.heap[e],n=e<<1;n<=t.heap_len&&(n<t.heap_len&&si(s,t.heap[n+1],t.heap[n],t.depth)&&n++,!si(s,i,t.heap[n],t.depth));)t.heap[e]=t.heap[n],e=n,n<<=1;t.heap[e]=i}function ri(t,s,e){var i,n,r=0,a,o;if(t.last_lit!==0)do i=t.pending_buf[t.d_buf+r*2]<<8|t.pending_buf[t.d_buf+r*2+1],n=t.pending_buf[t.l_buf+r],r++,i===0?G(t,n,s):(a=ze[n],G(t,a+Ce+1,s),o=_t[a],o!==0&&(n-=gt[a],M(t,n,o)),i--,a=Vt(i),G(t,a,e),o=qe[a],o!==0&&(i-=Ke[a],M(t,i,o)));while(r<t.last_lit);G(t,bt,s)}function yt(t,s){var e=s.dyn_tree,i=s.stat_desc.static_tree,n=s.stat_desc.has_stree,r=s.stat_desc.elems,a,o,u=-1,c;for(t.heap_len=0,t.heap_max=qt,a=0;a<r;a++)e[a*2]!==0?(t.heap[++t.heap_len]=u=a,t.depth[a]=0):e[a*2+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=u<2?++u:0,e[c*2]=1,t.depth[c]=0,t.opt_len--,n&&(t.static_len-=i[c*2+1]);for(s.max_code=u,a=t.heap_len>>1;a>=1;a--)wt(t,e,a);c=r;do a=t.heap[1],t.heap[1]=t.heap[t.heap_len--],wt(t,e,1),o=t.heap[1],t.heap[--t.heap_max]=a,t.heap[--t.heap_max]=o,e[c*2]=e[a*2]+e[o*2],t.depth[c]=(t.depth[a]>=t.depth[o]?t.depth[a]:t.depth[o])+1,e[a*2+1]=e[o*2+1]=c,t.heap[1]=c++,wt(t,e,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],Fn(t,s),ti(e,u,t.bl_count)}function ai(t,s,e){var i,n=-1,r,a=s[0*2+1],o=0,u=7,c=4;for(a===0&&(u=138,c=3),s[(e+1)*2+1]=65535,i=0;i<=e;i++)r=a,a=s[(i+1)*2+1],!(++o<u&&r===a)&&(o<c?t.bl_tree[r*2]+=o:r!==0?(r!==n&&t.bl_tree[r*2]++,t.bl_tree[Kt*2]++):o<=10?t.bl_tree[Ht*2]++:t.bl_tree[Gt*2]++,o=0,n=r,a===0?(u=138,c=3):r===a?(u=6,c=3):(u=7,c=4))}function oi(t,s,e){var i,n=-1,r,a=s[0*2+1],o=0,u=7,c=4;for(a===0&&(u=138,c=3),i=0;i<=e;i++)if(r=a,a=s[(i+1)*2+1],!(++o<u&&r===a)){if(o<c)do G(t,r,t.bl_tree);while(--o!==0);else r!==0?(r!==n&&(G(t,r,t.bl_tree),o--),G(t,Kt,t.bl_tree),M(t,o-3,2)):o<=10?(G(t,Ht,t.bl_tree),M(t,o-3,3)):(G(t,Gt,t.bl_tree),M(t,o-11,7));o=0,n=r,a===0?(u=138,c=3):r===a?(u=6,c=3):(u=7,c=4)}}function Kn(t){var s;for(ai(t,t.dyn_ltree,t.l_desc.max_code),ai(t,t.dyn_dtree,t.d_desc.max_code),yt(t,t.bl_desc),s=ht-1;s>=3&&t.bl_tree[Wt[s]*2+1]===0;s--);return t.opt_len+=3*(s+1)+5+5+4,s}function Hn(t,s,e,i){var n;for(M(t,s-257,5),M(t,e-1,5),M(t,i-4,4),n=0;n<i;n++)M(t,t.bl_tree[Wt[n]*2+1],3);oi(t,t.dyn_ltree,s-1),oi(t,t.dyn_dtree,e-1)}function Gn(t){var s=4093624447,e;for(e=0;e<=31;e++,s>>>=1)if(s&1&&t.dyn_ltree[e*2]!==0)return Jt;if(t.dyn_ltree[9*2]!==0||t.dyn_ltree[10*2]!==0||t.dyn_ltree[13*2]!==0)return Ft;for(e=32;e<Ce;e++)if(t.dyn_ltree[e*2]!==0)return Ft;return Jt}var ci=!1;function Wn(t){ci||(jn(),ci=!0),t.l_desc=new vt(t.dyn_ltree,Xt),t.d_desc=new vt(t.dyn_dtree,Yt),t.bl_desc=new vt(t.bl_tree,Qt),t.bi_buf=0,t.bi_valid=0,ii(t)}function li(t,s,e,i){M(t,($n<<1)+(i?1:0),3),qn(t,s,e,!0)}function Xn(t){M(t,jt<<1,3),G(t,bt,V),Jn(t)}function Yn(t,s,e,i){var n,r,a=0;t.level>0?(t.strm.data_type===Dn&&(t.strm.data_type=Gn(t)),yt(t,t.l_desc),yt(t,t.d_desc),a=Kn(t),n=t.opt_len+3+7>>>3,r=t.static_len+3+7>>>3,r<=n&&(n=r)):n=r=e+5,e+4<=n&&s!==-1?li(t,s,e,i):t.strategy===zn||r===n?(M(t,(jt<<1)+(i?1:0),3),ri(t,V,Pe)):(M(t,(Rn<<1)+(i?1:0),3),Hn(t,t.l_desc.max_code+1,t.d_desc.max_code+1,a+1),ri(t,t.dyn_ltree,t.dyn_dtree)),ii(t),i&&ni(t)}function Qn(t,s,e){return t.pending_buf[t.d_buf+t.last_lit*2]=s>>>8&255,t.pending_buf[t.d_buf+t.last_lit*2+1]=s&255,t.pending_buf[t.l_buf+t.last_lit]=e&255,t.last_lit++,s===0?t.dyn_ltree[e*2]++:(t.matches++,s--,t.dyn_ltree[(ze[e]+Ce+1)*2]++,t.dyn_dtree[Vt(s)*2]++),t.last_lit===t.lit_bufsize-1}ve._tr_init=Wn,ve._tr_stored_block=li,ve._tr_flush_block=Yn,ve._tr_tally=Qn,ve._tr_align=Xn;function Vn(t,s,e,i){for(var n=t&65535|0,r=t>>>16&65535|0,a=0;e!==0;){a=e>2e3?2e3:e,e-=a;do n=n+s[i++]|0,r=r+n|0;while(--a);n%=65521,r%=65521}return n|r<<16|0}var ui=Vn;function es(){for(var t,s=[],e=0;e<256;e++){t=e;for(var i=0;i<8;i++)t=t&1?3988292384^t>>>1:t>>>1;s[e]=t}return s}var ts=es();function is(t,s,e,i){var n=ts,r=i+e;t^=-1;for(var a=i;a<r;a++)t=t>>>8^n[(t^s[a])&255];return t^-1}var di=is,kt={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},B=Q,U=ve,fi=ui,te=di,ns=kt,de=0,ss=1,rs=3,ie=4,hi=5,W=0,pi=1,Z=-2,as=-3,xt=-5,os=-1,cs=1,He=2,ls=3,us=4,ds=0,fs=2,Ge=8,hs=9,ps=15,bs=8,_s=29,gs=256,St=gs+1+_s,ms=30,vs=19,ws=2*St+1,ys=15,S=3,ne=258,F=ne+S+1,ks=32,We=42,Tt=69,Xe=73,Ye=91,Qe=103,fe=113,$e=666,$=1,Re=2,he=3,ke=4,xs=3;function se(t,s){return t.msg=ns[s],s}function bi(t){return(t<<1)-(t>4?9:0)}function re(t){for(var s=t.length;--s>=0;)t[s]=0}function ae(t){var s=t.state,e=s.pending;e>t.avail_out&&(e=t.avail_out),e!==0&&(B.arraySet(t.output,s.pending_buf,s.pending_out,e,t.next_out),t.next_out+=e,s.pending_out+=e,t.total_out+=e,t.avail_out-=e,s.pending-=e,s.pending===0&&(s.pending_out=0))}function R(t,s){U._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,s),t.block_start=t.strstart,ae(t.strm)}function O(t,s){t.pending_buf[t.pending++]=s}function Be(t,s){t.pending_buf[t.pending++]=s>>>8&255,t.pending_buf[t.pending++]=s&255}function Ss(t,s,e,i){var n=t.avail_in;return n>i&&(n=i),n===0?0:(t.avail_in-=n,B.arraySet(s,t.input,t.next_in,n,e),t.state.wrap===1?t.adler=fi(t.adler,s,n,e):t.state.wrap===2&&(t.adler=te(t.adler,s,n,e)),t.next_in+=n,t.total_in+=n,n)}function _i(t,s){var e=t.max_chain_length,i=t.strstart,n,r,a=t.prev_length,o=t.nice_match,u=t.strstart>t.w_size-F?t.strstart-(t.w_size-F):0,c=t.window,l=t.w_mask,h=t.prev,p=t.strstart+ne,f=c[i+a-1],g=c[i+a];t.prev_length>=t.good_match&&(e>>=2),o>t.lookahead&&(o=t.lookahead);do if(n=s,!(c[n+a]!==g||c[n+a-1]!==f||c[n]!==c[i]||c[++n]!==c[i+1])){i+=2,n++;do;while(c[++i]===c[++n]&&c[++i]===c[++n]&&c[++i]===c[++n]&&c[++i]===c[++n]&&c[++i]===c[++n]&&c[++i]===c[++n]&&c[++i]===c[++n]&&c[++i]===c[++n]&&i<p);if(r=ne-(p-i),i=p-ne,r>a){if(t.match_start=s,a=r,r>=o)break;f=c[i+a-1],g=c[i+a]}}while((s=h[s&l])>u&&--e!==0);return a<=t.lookahead?a:t.lookahead}function pe(t){var s=t.w_size,e,i,n,r,a;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=s+(s-F)){B.arraySet(t.window,t.window,s,s,0),t.match_start-=s,t.strstart-=s,t.block_start-=s,i=t.hash_size,e=i;do n=t.head[--e],t.head[e]=n>=s?n-s:0;while(--i);i=s,e=i;do n=t.prev[--e],t.prev[e]=n>=s?n-s:0;while(--i);r+=s}if(t.strm.avail_in===0)break;if(i=Ss(t.strm,t.window,t.strstart+t.lookahead,r),t.lookahead+=i,t.lookahead+t.insert>=S)for(a=t.strstart-t.insert,t.ins_h=t.window[a],t.ins_h=(t.ins_h<<t.hash_shift^t.window[a+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[a+S-1])&t.hash_mask,t.prev[a&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=a,a++,t.insert--,!(t.lookahead+t.insert<S)););}while(t.lookahead<F&&t.strm.avail_in!==0)}function Ts(t,s){var e=65535;for(e>t.pending_buf_size-5&&(e=t.pending_buf_size-5);;){if(t.lookahead<=1){if(pe(t),t.lookahead===0&&s===de)return $;if(t.lookahead===0)break}t.strstart+=t.lookahead,t.lookahead=0;var i=t.block_start+e;if((t.strstart===0||t.strstart>=i)&&(t.lookahead=t.strstart-i,t.strstart=i,R(t,!1),t.strm.avail_out===0)||t.strstart-t.block_start>=t.w_size-F&&(R(t,!1),t.strm.avail_out===0))return $}return t.insert=0,s===ie?(R(t,!0),t.strm.avail_out===0?he:ke):(t.strstart>t.block_start&&(R(t,!1),t.strm.avail_out===0),$)}function Et(t,s){for(var e,i;;){if(t.lookahead<F){if(pe(t),t.lookahead<F&&s===de)return $;if(t.lookahead===0)break}if(e=0,t.lookahead>=S&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),e!==0&&t.strstart-e<=t.w_size-F&&(t.match_length=_i(t,e)),t.match_length>=S)if(i=U._tr_tally(t,t.strstart-t.match_start,t.match_length-S),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=S){t.match_length--;do t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!==0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else i=U._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(R(t,!1),t.strm.avail_out===0))return $}return t.insert=t.strstart<S-1?t.strstart:S-1,s===ie?(R(t,!0),t.strm.avail_out===0?he:ke):t.last_lit&&(R(t,!1),t.strm.avail_out===0)?$:Re}function xe(t,s){for(var e,i,n;;){if(t.lookahead<F){if(pe(t),t.lookahead<F&&s===de)return $;if(t.lookahead===0)break}if(e=0,t.lookahead>=S&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=S-1,e!==0&&t.prev_length<t.max_lazy_match&&t.strstart-e<=t.w_size-F&&(t.match_length=_i(t,e),t.match_length<=5&&(t.strategy===cs||t.match_length===S&&t.strstart-t.match_start>4096)&&(t.match_length=S-1)),t.prev_length>=S&&t.match_length<=t.prev_length){n=t.strstart+t.lookahead-S,i=U._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-S),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=n&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+S-1])&t.hash_mask,e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!==0);if(t.match_available=0,t.match_length=S-1,t.strstart++,i&&(R(t,!1),t.strm.avail_out===0))return $}else if(t.match_available){if(i=U._tr_tally(t,0,t.window[t.strstart-1]),i&&R(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return $}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(i=U._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<S-1?t.strstart:S-1,s===ie?(R(t,!0),t.strm.avail_out===0?he:ke):t.last_lit&&(R(t,!1),t.strm.avail_out===0)?$:Re}function Es(t,s){for(var e,i,n,r,a=t.window;;){if(t.lookahead<=ne){if(pe(t),t.lookahead<=ne&&s===de)return $;if(t.lookahead===0)break}if(t.match_length=0,t.lookahead>=S&&t.strstart>0&&(n=t.strstart-1,i=a[n],i===a[++n]&&i===a[++n]&&i===a[++n])){r=t.strstart+ne;do;while(i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&n<r);t.match_length=ne-(r-n),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=S?(e=U._tr_tally(t,1,t.match_length-S),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(e=U._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),e&&(R(t,!1),t.strm.avail_out===0))return $}return t.insert=0,s===ie?(R(t,!0),t.strm.avail_out===0?he:ke):t.last_lit&&(R(t,!1),t.strm.avail_out===0)?$:Re}function Os(t,s){for(var e;;){if(t.lookahead===0&&(pe(t),t.lookahead===0)){if(s===de)return $;break}if(t.match_length=0,e=U._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,e&&(R(t,!1),t.strm.avail_out===0))return $}return t.insert=0,s===ie?(R(t,!0),t.strm.avail_out===0?he:ke):t.last_lit&&(R(t,!1),t.strm.avail_out===0)?$:Re}function X(t,s,e,i,n){this.good_length=t,this.max_lazy=s,this.nice_length=e,this.max_chain=i,this.func=n}var Se;Se=[new X(0,0,0,0,Ts),new X(4,4,8,4,Et),new X(4,5,16,8,Et),new X(4,6,32,32,Et),new X(4,4,16,16,xe),new X(8,16,32,32,xe),new X(8,16,128,128,xe),new X(8,32,128,256,xe),new X(32,128,258,1024,xe),new X(32,258,258,4096,xe)];function As(t){t.window_size=2*t.w_size,re(t.head),t.max_lazy_match=Se[t.level].max_lazy,t.good_match=Se[t.level].good_length,t.nice_match=Se[t.level].nice_length,t.max_chain_length=Se[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=S-1,t.match_available=0,t.ins_h=0}function Cs(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Ge,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new B.Buf16(ws*2),this.dyn_dtree=new B.Buf16((2*ms+1)*2),this.bl_tree=new B.Buf16((2*vs+1)*2),re(this.dyn_ltree),re(this.dyn_dtree),re(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new B.Buf16(ys+1),this.heap=new B.Buf16(2*St+1),re(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new B.Buf16(2*St+1),re(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function gi(t){var s;return!t||!t.state?se(t,Z):(t.total_in=t.total_out=0,t.data_type=fs,s=t.state,s.pending=0,s.pending_out=0,s.wrap<0&&(s.wrap=-s.wrap),s.status=s.wrap?We:fe,t.adler=s.wrap===2?0:1,s.last_flush=de,U._tr_init(s),W)}function mi(t){var s=gi(t);return s===W&&As(t.state),s}function Ns(t,s){return!t||!t.state||t.state.wrap!==2?Z:(t.state.gzhead=s,W)}function vi(t,s,e,i,n,r){if(!t)return Z;var a=1;if(s===os&&(s=6),i<0?(a=0,i=-i):i>15&&(a=2,i-=16),n<1||n>hs||e!==Ge||i<8||i>15||s<0||s>9||r<0||r>us)return se(t,Z);i===8&&(i=9);var o=new Cs;return t.state=o,o.strm=t,o.wrap=a,o.gzhead=null,o.w_bits=i,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=n+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+S-1)/S),o.window=new B.Buf8(o.w_size*2),o.head=new B.Buf16(o.hash_size),o.prev=new B.Buf16(o.w_size),o.lit_bufsize=1<<n+6,o.pending_buf_size=o.lit_bufsize*4,o.pending_buf=new B.Buf8(o.pending_buf_size),o.d_buf=1*o.lit_bufsize,o.l_buf=(1+2)*o.lit_bufsize,o.level=s,o.strategy=r,o.method=e,mi(t)}function Ps(t,s){return vi(t,s,Ge,ps,bs,ds)}function Is(t,s){var e,i,n,r;if(!t||!t.state||s>hi||s<0)return t?se(t,Z):Z;if(i=t.state,!t.output||!t.input&&t.avail_in!==0||i.status===$e&&s!==ie)return se(t,t.avail_out===0?xt:Z);if(i.strm=t,e=i.last_flush,i.last_flush=s,i.status===We)if(i.wrap===2)t.adler=0,O(i,31),O(i,139),O(i,8),i.gzhead?(O(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),O(i,i.gzhead.time&255),O(i,i.gzhead.time>>8&255),O(i,i.gzhead.time>>16&255),O(i,i.gzhead.time>>24&255),O(i,i.level===9?2:i.strategy>=He||i.level<2?4:0),O(i,i.gzhead.os&255),i.gzhead.extra&&i.gzhead.extra.length&&(O(i,i.gzhead.extra.length&255),O(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(t.adler=te(t.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=Tt):(O(i,0),O(i,0),O(i,0),O(i,0),O(i,0),O(i,i.level===9?2:i.strategy>=He||i.level<2?4:0),O(i,xs),i.status=fe);else{var a=Ge+(i.w_bits-8<<4)<<8,o=-1;i.strategy>=He||i.level<2?o=0:i.level<6?o=1:i.level===6?o=2:o=3,a|=o<<6,i.strstart!==0&&(a|=ks),a+=31-a%31,i.status=fe,Be(i,a),i.strstart!==0&&(Be(i,t.adler>>>16),Be(i,t.adler&65535)),t.adler=1}if(i.status===Tt)if(i.gzhead.extra){for(n=i.pending;i.gzindex<(i.gzhead.extra.length&65535)&&!(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(t.adler=te(t.adler,i.pending_buf,i.pending-n,n)),ae(t),n=i.pending,i.pending===i.pending_buf_size));)O(i,i.gzhead.extra[i.gzindex]&255),i.gzindex++;i.gzhead.hcrc&&i.pending>n&&(t.adler=te(t.adler,i.pending_buf,i.pending-n,n)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=Xe)}else i.status=Xe;if(i.status===Xe)if(i.gzhead.name){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(t.adler=te(t.adler,i.pending_buf,i.pending-n,n)),ae(t),n=i.pending,i.pending===i.pending_buf_size)){r=1;break}i.gzindex<i.gzhead.name.length?r=i.gzhead.name.charCodeAt(i.gzindex++)&255:r=0,O(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>n&&(t.adler=te(t.adler,i.pending_buf,i.pending-n,n)),r===0&&(i.gzindex=0,i.status=Ye)}else i.status=Ye;if(i.status===Ye)if(i.gzhead.comment){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(t.adler=te(t.adler,i.pending_buf,i.pending-n,n)),ae(t),n=i.pending,i.pending===i.pending_buf_size)){r=1;break}i.gzindex<i.gzhead.comment.length?r=i.gzhead.comment.charCodeAt(i.gzindex++)&255:r=0,O(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>n&&(t.adler=te(t.adler,i.pending_buf,i.pending-n,n)),r===0&&(i.status=Qe)}else i.status=Qe;if(i.status===Qe&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&ae(t),i.pending+2<=i.pending_buf_size&&(O(i,t.adler&255),O(i,t.adler>>8&255),t.adler=0,i.status=fe)):i.status=fe),i.pending!==0){if(ae(t),t.avail_out===0)return i.last_flush=-1,W}else if(t.avail_in===0&&bi(s)<=bi(e)&&s!==ie)return se(t,xt);if(i.status===$e&&t.avail_in!==0)return se(t,xt);if(t.avail_in!==0||i.lookahead!==0||s!==de&&i.status!==$e){var u=i.strategy===He?Os(i,s):i.strategy===ls?Es(i,s):Se[i.level].func(i,s);if((u===he||u===ke)&&(i.status=$e),u===$||u===he)return t.avail_out===0&&(i.last_flush=-1),W;if(u===Re&&(s===ss?U._tr_align(i):s!==hi&&(U._tr_stored_block(i,0,0,!1),s===rs&&(re(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0))),ae(t),t.avail_out===0))return i.last_flush=-1,W}return s!==ie?W:i.wrap<=0?pi:(i.wrap===2?(O(i,t.adler&255),O(i,t.adler>>8&255),O(i,t.adler>>16&255),O(i,t.adler>>24&255),O(i,t.total_in&255),O(i,t.total_in>>8&255),O(i,t.total_in>>16&255),O(i,t.total_in>>24&255)):(Be(i,t.adler>>>16),Be(i,t.adler&65535)),ae(t),i.wrap>0&&(i.wrap=-i.wrap),i.pending!==0?W:pi)}function zs(t){var s;return!t||!t.state?Z:(s=t.state.status,s!==We&&s!==Tt&&s!==Xe&&s!==Ye&&s!==Qe&&s!==fe&&s!==$e?se(t,Z):(t.state=null,s===fe?se(t,as):W))}function Ds(t,s){var e=s.length,i,n,r,a,o,u,c,l;if(!t||!t.state||(i=t.state,a=i.wrap,a===2||a===1&&i.status!==We||i.lookahead))return Z;for(a===1&&(t.adler=fi(t.adler,s,e,0)),i.wrap=0,e>=i.w_size&&(a===0&&(re(i.head),i.strstart=0,i.block_start=0,i.insert=0),l=new B.Buf8(i.w_size),B.arraySet(l,s,e-i.w_size,i.w_size,0),s=l,e=i.w_size),o=t.avail_in,u=t.next_in,c=t.input,t.avail_in=e,t.next_in=0,t.input=s,pe(i);i.lookahead>=S;){n=i.strstart,r=i.lookahead-(S-1);do i.ins_h=(i.ins_h<<i.hash_shift^i.window[n+S-1])&i.hash_mask,i.prev[n&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=n,n++;while(--r);i.strstart=n,i.lookahead=S-1,pe(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=S-1,i.match_available=0,t.next_in=u,t.input=c,t.avail_in=o,i.wrap=a,W}H.deflateInit=Ps,H.deflateInit2=vi,H.deflateReset=mi,H.deflateResetKeep=gi,H.deflateSetHeader=Ns,H.deflate=Is,H.deflateEnd=zs,H.deflateSetDictionary=Ds,H.deflateInfo="pako deflate (from Nodeca project)";var be={},Ve=Q,wi=!0,yi=!0;try{String.fromCharCode.apply(null,[0])}catch{wi=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{yi=!1}for(var Me=new Ve.Buf8(256),oe=0;oe<256;oe++)Me[oe]=oe>=252?6:oe>=248?5:oe>=240?4:oe>=224?3:oe>=192?2:1;Me[254]=Me[254]=1,be.string2buf=function(t){var s,e,i,n,r,a=t.length,o=0;for(n=0;n<a;n++)e=t.charCodeAt(n),(e&64512)===55296&&n+1<a&&(i=t.charCodeAt(n+1),(i&64512)===56320&&(e=65536+(e-55296<<10)+(i-56320),n++)),o+=e<128?1:e<2048?2:e<65536?3:4;for(s=new Ve.Buf8(o),r=0,n=0;r<o;n++)e=t.charCodeAt(n),(e&64512)===55296&&n+1<a&&(i=t.charCodeAt(n+1),(i&64512)===56320&&(e=65536+(e-55296<<10)+(i-56320),n++)),e<128?s[r++]=e:e<2048?(s[r++]=192|e>>>6,s[r++]=128|e&63):e<65536?(s[r++]=224|e>>>12,s[r++]=128|e>>>6&63,s[r++]=128|e&63):(s[r++]=240|e>>>18,s[r++]=128|e>>>12&63,s[r++]=128|e>>>6&63,s[r++]=128|e&63);return s};function ki(t,s){if(s<65534&&(t.subarray&&yi||!t.subarray&&wi))return String.fromCharCode.apply(null,Ve.shrinkBuf(t,s));for(var e="",i=0;i<s;i++)e+=String.fromCharCode(t[i]);return e}be.buf2binstring=function(t){return ki(t,t.length)},be.binstring2buf=function(t){for(var s=new Ve.Buf8(t.length),e=0,i=s.length;e<i;e++)s[e]=t.charCodeAt(e);return s},be.buf2string=function(t,s){var e,i,n,r,a=s||t.length,o=new Array(a*2);for(i=0,e=0;e<a;){if(n=t[e++],n<128){o[i++]=n;continue}if(r=Me[n],r>4){o[i++]=65533,e+=r-1;continue}for(n&=r===2?31:r===3?15:7;r>1&&e<a;)n=n<<6|t[e++]&63,r--;if(r>1){o[i++]=65533;continue}n<65536?o[i++]=n:(n-=65536,o[i++]=55296|n>>10&1023,o[i++]=56320|n&1023)}return ki(o,i)},be.utf8border=function(t,s){var e;for(s=s||t.length,s>t.length&&(s=t.length),e=s-1;e>=0&&(t[e]&192)===128;)e--;return e<0||e===0?s:e+Me[t[e]]>s?e:s};function $s(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var xi=$s,Le=H,Ue=Q,Ot=be,At=kt,Rs=xi,Si=Object.prototype.toString,Bs=0,Ct=4,Te=0,Ti=1,Ei=2,Ms=-1,Ls=0,Us=8;function _e(t){if(!(this instanceof _e))return new _e(t);this.options=Ue.assign({level:Ms,method:Us,chunkSize:16384,windowBits:15,memLevel:8,strategy:Ls,to:""},t||{});var s=this.options;s.raw&&s.windowBits>0?s.windowBits=-s.windowBits:s.gzip&&s.windowBits>0&&s.windowBits<16&&(s.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Rs,this.strm.avail_out=0;var e=Le.deflateInit2(this.strm,s.level,s.method,s.windowBits,s.memLevel,s.strategy);if(e!==Te)throw new Error(At[e]);if(s.header&&Le.deflateSetHeader(this.strm,s.header),s.dictionary){var i;if(typeof s.dictionary=="string"?i=Ot.string2buf(s.dictionary):Si.call(s.dictionary)==="[object ArrayBuffer]"?i=new Uint8Array(s.dictionary):i=s.dictionary,e=Le.deflateSetDictionary(this.strm,i),e!==Te)throw new Error(At[e]);this._dict_set=!0}}_e.prototype.push=function(t,s){var e=this.strm,i=this.options.chunkSize,n,r;if(this.ended)return!1;r=s===~~s?s:s===!0?Ct:Bs,typeof t=="string"?e.input=Ot.string2buf(t):Si.call(t)==="[object ArrayBuffer]"?e.input=new Uint8Array(t):e.input=t,e.next_in=0,e.avail_in=e.input.length;do{if(e.avail_out===0&&(e.output=new Ue.Buf8(i),e.next_out=0,e.avail_out=i),n=Le.deflate(e,r),n!==Ti&&n!==Te)return this.onEnd(n),this.ended=!0,!1;(e.avail_out===0||e.avail_in===0&&(r===Ct||r===Ei))&&(this.options.to==="string"?this.onData(Ot.buf2binstring(Ue.shrinkBuf(e.output,e.next_out))):this.onData(Ue.shrinkBuf(e.output,e.next_out)))}while((e.avail_in>0||e.avail_out===0)&&n!==Ti);return r===Ct?(n=Le.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===Te):(r===Ei&&(this.onEnd(Te),e.avail_out=0),!0)},_e.prototype.onData=function(t){this.chunks.push(t)},_e.prototype.onEnd=function(t){t===Te&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Ue.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};function Nt(t,s){var e=new _e(s);if(e.push(t,!0),e.err)throw e.msg||At[e.err];return e.result}function Zs(t,s){return s=s||{},s.raw=!0,Nt(t,s)}function Js(t,s){return s=s||{},s.gzip=!0,Nt(t,s)}Ae.Deflate=_e,Ae.deflate=Nt,Ae.deflateRaw=Zs,Ae.gzip=Js;var Ze={},j={},et=30,Fs=12,js=function(s,e){var i,n,r,a,o,u,c,l,h,p,f,g,m,b,v,T,w,x,_,C,E,y,A,D,k;i=s.state,n=s.next_in,D=s.input,r=n+(s.avail_in-5),a=s.next_out,k=s.output,o=a-(e-s.avail_out),u=a+(s.avail_out-257),c=i.dmax,l=i.wsize,h=i.whave,p=i.wnext,f=i.window,g=i.hold,m=i.bits,b=i.lencode,v=i.distcode,T=(1<<i.lenbits)-1,w=(1<<i.distbits)-1;e:do{m<15&&(g+=D[n++]<<m,m+=8,g+=D[n++]<<m,m+=8),x=b[g&T];t:for(;;){if(_=x>>>24,g>>>=_,m-=_,_=x>>>16&255,_===0)k[a++]=x&65535;else if(_&16){C=x&65535,_&=15,_&&(m<_&&(g+=D[n++]<<m,m+=8),C+=g&(1<<_)-1,g>>>=_,m-=_),m<15&&(g+=D[n++]<<m,m+=8,g+=D[n++]<<m,m+=8),x=v[g&w];i:for(;;){if(_=x>>>24,g>>>=_,m-=_,_=x>>>16&255,_&16){if(E=x&65535,_&=15,m<_&&(g+=D[n++]<<m,m+=8,m<_&&(g+=D[n++]<<m,m+=8)),E+=g&(1<<_)-1,E>c){s.msg="invalid distance too far back",i.mode=et;break e}if(g>>>=_,m-=_,_=a-o,E>_){if(_=E-_,_>h&&i.sane){s.msg="invalid distance too far back",i.mode=et;break e}if(y=0,A=f,p===0){if(y+=l-_,_<C){C-=_;do k[a++]=f[y++];while(--_);y=a-E,A=k}}else if(p<_){if(y+=l+p-_,_-=p,_<C){C-=_;do k[a++]=f[y++];while(--_);if(y=0,p<C){_=p,C-=_;do k[a++]=f[y++];while(--_);y=a-E,A=k}}}else if(y+=p-_,_<C){C-=_;do k[a++]=f[y++];while(--_);y=a-E,A=k}for(;C>2;)k[a++]=A[y++],k[a++]=A[y++],k[a++]=A[y++],C-=3;C&&(k[a++]=A[y++],C>1&&(k[a++]=A[y++]))}else{y=a-E;do k[a++]=k[y++],k[a++]=k[y++],k[a++]=k[y++],C-=3;while(C>2);C&&(k[a++]=k[y++],C>1&&(k[a++]=k[y++]))}}else if(_&64){s.msg="invalid distance code",i.mode=et;break e}else{x=v[(x&65535)+(g&(1<<_)-1)];continue i}break}}else if(_&64)if(_&32){i.mode=Fs;break e}else{s.msg="invalid literal/length code",i.mode=et;break e}else{x=b[(x&65535)+(g&(1<<_)-1)];continue t}break}}while(n<r&&a<u);C=m>>3,n-=C,m-=C<<3,g&=(1<<m)-1,s.next_in=n,s.next_out=a,s.avail_in=n<r?5+(r-n):5-(n-r),s.avail_out=a<u?257+(u-a):257-(a-u),i.hold=g,i.bits=m},Oi=Q,Ee=15,Ai=852,Ci=592,Ni=0,Pt=1,Pi=2,qs=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Ks=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Hs=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],Gs=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],Ws=function(s,e,i,n,r,a,o,u){var c=u.bits,l=0,h=0,p=0,f=0,g=0,m=0,b=0,v=0,T=0,w=0,x,_,C,E,y,A=null,D=0,k,q=new Oi.Buf16(Ee+1),ct=new Oi.Buf16(Ee+1),lt=null,xn=0,Sn,ut,dt;for(l=0;l<=Ee;l++)q[l]=0;for(h=0;h<n;h++)q[e[i+h]]++;for(g=c,f=Ee;f>=1&&q[f]===0;f--);if(g>f&&(g=f),f===0)return r[a++]=1<<24|64<<16|0,r[a++]=1<<24|64<<16|0,u.bits=1,0;for(p=1;p<f&&q[p]===0;p++);for(g<p&&(g=p),v=1,l=1;l<=Ee;l++)if(v<<=1,v-=q[l],v<0)return-1;if(v>0&&(s===Ni||f!==1))return-1;for(ct[1]=0,l=1;l<Ee;l++)ct[l+1]=ct[l]+q[l];for(h=0;h<n;h++)e[i+h]!==0&&(o[ct[e[i+h]]++]=h);if(s===Ni?(A=lt=o,k=19):s===Pt?(A=qs,D-=257,lt=Ks,xn-=257,k=256):(A=Hs,lt=Gs,k=-1),w=0,h=0,l=p,y=a,m=g,b=0,C=-1,T=1<<g,E=T-1,s===Pt&&T>Ai||s===Pi&&T>Ci)return 1;for(;;){Sn=l-b,o[h]<k?(ut=0,dt=o[h]):o[h]>k?(ut=lt[xn+o[h]],dt=A[D+o[h]]):(ut=32+64,dt=0),x=1<<l-b,_=1<<m,p=_;do _-=x,r[y+(w>>b)+_]=Sn<<24|ut<<16|dt|0;while(_!==0);for(x=1<<l-1;w&x;)x>>=1;if(x!==0?(w&=x-1,w+=x):w=0,h++,--q[l]===0){if(l===f)break;l=e[i+o[h]]}if(l>g&&(w&E)!==C){for(b===0&&(b=g),y+=p,m=l-b,v=1<<m;m+b<f&&(v-=q[m+b],!(v<=0));)m++,v<<=1;if(T+=1<<m,s===Pt&&T>Ai||s===Pi&&T>Ci)return 1;C=w&E,r[C]=g<<24|m<<16|y-a|0}}return w!==0&&(r[y+w]=l-b<<24|64<<16|0),u.bits=g,0},L=Q,It=ui,Y=di,Xs=js,Je=Ws,Ys=0,Ii=1,zi=2,Di=4,Qs=5,tt=6,ge=0,Vs=1,er=2,J=-2,$i=-3,Ri=-4,tr=-5,Bi=8,Mi=1,Li=2,Ui=3,Zi=4,Ji=5,Fi=6,ji=7,qi=8,Ki=9,Hi=10,it=11,ee=12,zt=13,Gi=14,Dt=15,Wi=16,Xi=17,Yi=18,Qi=19,nt=20,st=21,Vi=22,en=23,tn=24,nn=25,sn=26,$t=27,rn=28,an=29,I=30,on=31,ir=32,nr=852,sr=592,rr=15,ar=rr;function cn(t){return(t>>>24&255)+(t>>>8&65280)+((t&65280)<<8)+((t&255)<<24)}function or(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new L.Buf16(320),this.work=new L.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function ln(t){var s;return!t||!t.state?J:(s=t.state,t.total_in=t.total_out=s.total=0,t.msg="",s.wrap&&(t.adler=s.wrap&1),s.mode=Mi,s.last=0,s.havedict=0,s.dmax=32768,s.head=null,s.hold=0,s.bits=0,s.lencode=s.lendyn=new L.Buf32(nr),s.distcode=s.distdyn=new L.Buf32(sr),s.sane=1,s.back=-1,ge)}function un(t){var s;return!t||!t.state?J:(s=t.state,s.wsize=0,s.whave=0,s.wnext=0,ln(t))}function dn(t,s){var e,i;return!t||!t.state||(i=t.state,s<0?(e=0,s=-s):(e=(s>>4)+1,s<48&&(s&=15)),s&&(s<8||s>15))?J:(i.window!==null&&i.wbits!==s&&(i.window=null),i.wrap=e,i.wbits=s,un(t))}function fn(t,s){var e,i;return t?(i=new or,t.state=i,i.window=null,e=dn(t,s),e!==ge&&(t.state=null),e):J}function cr(t){return fn(t,ar)}var hn=!0,Rt,Bt;function lr(t){if(hn){var s;for(Rt=new L.Buf32(512),Bt=new L.Buf32(32),s=0;s<144;)t.lens[s++]=8;for(;s<256;)t.lens[s++]=9;for(;s<280;)t.lens[s++]=7;for(;s<288;)t.lens[s++]=8;for(Je(Ii,t.lens,0,288,Rt,0,t.work,{bits:9}),s=0;s<32;)t.lens[s++]=5;Je(zi,t.lens,0,32,Bt,0,t.work,{bits:5}),hn=!1}t.lencode=Rt,t.lenbits=9,t.distcode=Bt,t.distbits=5}function pn(t,s,e,i){var n,r=t.state;return r.window===null&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new L.Buf8(r.wsize)),i>=r.wsize?(L.arraySet(r.window,s,e-r.wsize,r.wsize,0),r.wnext=0,r.whave=r.wsize):(n=r.wsize-r.wnext,n>i&&(n=i),L.arraySet(r.window,s,e-i,n,r.wnext),i-=n,i?(L.arraySet(r.window,s,e-i,i,0),r.wnext=i,r.whave=r.wsize):(r.wnext+=n,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=n))),0}function ur(t,s){var e,i,n,r,a,o,u,c,l,h,p,f,g,m,b=0,v,T,w,x,_,C,E,y,A=new L.Buf8(4),D,k,q=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&t.avail_in!==0)return J;e=t.state,e.mode===ee&&(e.mode=zt),a=t.next_out,n=t.output,u=t.avail_out,r=t.next_in,i=t.input,o=t.avail_in,c=e.hold,l=e.bits,h=o,p=u,y=ge;e:for(;;)switch(e.mode){case Mi:if(e.wrap===0){e.mode=zt;break}for(;l<16;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(e.wrap&2&&c===35615){e.check=0,A[0]=c&255,A[1]=c>>>8&255,e.check=Y(e.check,A,2,0),c=0,l=0,e.mode=Li;break}if(e.flags=0,e.head&&(e.head.done=!1),!(e.wrap&1)||(((c&255)<<8)+(c>>8))%31){t.msg="incorrect header check",e.mode=I;break}if((c&15)!==Bi){t.msg="unknown compression method",e.mode=I;break}if(c>>>=4,l-=4,E=(c&15)+8,e.wbits===0)e.wbits=E;else if(E>e.wbits){t.msg="invalid window size",e.mode=I;break}e.dmax=1<<E,t.adler=e.check=1,e.mode=c&512?Hi:ee,c=0,l=0;break;case Li:for(;l<16;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(e.flags=c,(e.flags&255)!==Bi){t.msg="unknown compression method",e.mode=I;break}if(e.flags&57344){t.msg="unknown header flags set",e.mode=I;break}e.head&&(e.head.text=c>>8&1),e.flags&512&&(A[0]=c&255,A[1]=c>>>8&255,e.check=Y(e.check,A,2,0)),c=0,l=0,e.mode=Ui;case Ui:for(;l<32;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}e.head&&(e.head.time=c),e.flags&512&&(A[0]=c&255,A[1]=c>>>8&255,A[2]=c>>>16&255,A[3]=c>>>24&255,e.check=Y(e.check,A,4,0)),c=0,l=0,e.mode=Zi;case Zi:for(;l<16;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}e.head&&(e.head.xflags=c&255,e.head.os=c>>8),e.flags&512&&(A[0]=c&255,A[1]=c>>>8&255,e.check=Y(e.check,A,2,0)),c=0,l=0,e.mode=Ji;case Ji:if(e.flags&1024){for(;l<16;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}e.length=c,e.head&&(e.head.extra_len=c),e.flags&512&&(A[0]=c&255,A[1]=c>>>8&255,e.check=Y(e.check,A,2,0)),c=0,l=0}else e.head&&(e.head.extra=null);e.mode=Fi;case Fi:if(e.flags&1024&&(f=e.length,f>o&&(f=o),f&&(e.head&&(E=e.head.extra_len-e.length,e.head.extra||(e.head.extra=new Array(e.head.extra_len)),L.arraySet(e.head.extra,i,r,f,E)),e.flags&512&&(e.check=Y(e.check,i,f,r)),o-=f,r+=f,e.length-=f),e.length))break e;e.length=0,e.mode=ji;case ji:if(e.flags&2048){if(o===0)break e;f=0;do E=i[r+f++],e.head&&E&&e.length<65536&&(e.head.name+=String.fromCharCode(E));while(E&&f<o);if(e.flags&512&&(e.check=Y(e.check,i,f,r)),o-=f,r+=f,E)break e}else e.head&&(e.head.name=null);e.length=0,e.mode=qi;case qi:if(e.flags&4096){if(o===0)break e;f=0;do E=i[r+f++],e.head&&E&&e.length<65536&&(e.head.comment+=String.fromCharCode(E));while(E&&f<o);if(e.flags&512&&(e.check=Y(e.check,i,f,r)),o-=f,r+=f,E)break e}else e.head&&(e.head.comment=null);e.mode=Ki;case Ki:if(e.flags&512){for(;l<16;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(c!==(e.check&65535)){t.msg="header crc mismatch",e.mode=I;break}c=0,l=0}e.head&&(e.head.hcrc=e.flags>>9&1,e.head.done=!0),t.adler=e.check=0,e.mode=ee;break;case Hi:for(;l<32;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}t.adler=e.check=cn(c),c=0,l=0,e.mode=it;case it:if(e.havedict===0)return t.next_out=a,t.avail_out=u,t.next_in=r,t.avail_in=o,e.hold=c,e.bits=l,er;t.adler=e.check=1,e.mode=ee;case ee:if(s===Qs||s===tt)break e;case zt:if(e.last){c>>>=l&7,l-=l&7,e.mode=$t;break}for(;l<3;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}switch(e.last=c&1,c>>>=1,l-=1,c&3){case 0:e.mode=Gi;break;case 1:if(lr(e),e.mode=nt,s===tt){c>>>=2,l-=2;break e}break;case 2:e.mode=Xi;break;case 3:t.msg="invalid block type",e.mode=I}c>>>=2,l-=2;break;case Gi:for(c>>>=l&7,l-=l&7;l<32;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if((c&65535)!==(c>>>16^65535)){t.msg="invalid stored block lengths",e.mode=I;break}if(e.length=c&65535,c=0,l=0,e.mode=Dt,s===tt)break e;case Dt:e.mode=Wi;case Wi:if(f=e.length,f){if(f>o&&(f=o),f>u&&(f=u),f===0)break e;L.arraySet(n,i,r,f,a),o-=f,r+=f,u-=f,a+=f,e.length-=f;break}e.mode=ee;break;case Xi:for(;l<14;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(e.nlen=(c&31)+257,c>>>=5,l-=5,e.ndist=(c&31)+1,c>>>=5,l-=5,e.ncode=(c&15)+4,c>>>=4,l-=4,e.nlen>286||e.ndist>30){t.msg="too many length or distance symbols",e.mode=I;break}e.have=0,e.mode=Yi;case Yi:for(;e.have<e.ncode;){for(;l<3;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}e.lens[q[e.have++]]=c&7,c>>>=3,l-=3}for(;e.have<19;)e.lens[q[e.have++]]=0;if(e.lencode=e.lendyn,e.lenbits=7,D={bits:e.lenbits},y=Je(Ys,e.lens,0,19,e.lencode,0,e.work,D),e.lenbits=D.bits,y){t.msg="invalid code lengths set",e.mode=I;break}e.have=0,e.mode=Qi;case Qi:for(;e.have<e.nlen+e.ndist;){for(;b=e.lencode[c&(1<<e.lenbits)-1],v=b>>>24,T=b>>>16&255,w=b&65535,!(v<=l);){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(w<16)c>>>=v,l-=v,e.lens[e.have++]=w;else{if(w===16){for(k=v+2;l<k;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(c>>>=v,l-=v,e.have===0){t.msg="invalid bit length repeat",e.mode=I;break}E=e.lens[e.have-1],f=3+(c&3),c>>>=2,l-=2}else if(w===17){for(k=v+3;l<k;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}c>>>=v,l-=v,E=0,f=3+(c&7),c>>>=3,l-=3}else{for(k=v+7;l<k;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}c>>>=v,l-=v,E=0,f=11+(c&127),c>>>=7,l-=7}if(e.have+f>e.nlen+e.ndist){t.msg="invalid bit length repeat",e.mode=I;break}for(;f--;)e.lens[e.have++]=E}}if(e.mode===I)break;if(e.lens[256]===0){t.msg="invalid code -- missing end-of-block",e.mode=I;break}if(e.lenbits=9,D={bits:e.lenbits},y=Je(Ii,e.lens,0,e.nlen,e.lencode,0,e.work,D),e.lenbits=D.bits,y){t.msg="invalid literal/lengths set",e.mode=I;break}if(e.distbits=6,e.distcode=e.distdyn,D={bits:e.distbits},y=Je(zi,e.lens,e.nlen,e.ndist,e.distcode,0,e.work,D),e.distbits=D.bits,y){t.msg="invalid distances set",e.mode=I;break}if(e.mode=nt,s===tt)break e;case nt:e.mode=st;case st:if(o>=6&&u>=258){t.next_out=a,t.avail_out=u,t.next_in=r,t.avail_in=o,e.hold=c,e.bits=l,Xs(t,p),a=t.next_out,n=t.output,u=t.avail_out,r=t.next_in,i=t.input,o=t.avail_in,c=e.hold,l=e.bits,e.mode===ee&&(e.back=-1);break}for(e.back=0;b=e.lencode[c&(1<<e.lenbits)-1],v=b>>>24,T=b>>>16&255,w=b&65535,!(v<=l);){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(T&&!(T&240)){for(x=v,_=T,C=w;b=e.lencode[C+((c&(1<<x+_)-1)>>x)],v=b>>>24,T=b>>>16&255,w=b&65535,!(x+v<=l);){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}c>>>=x,l-=x,e.back+=x}if(c>>>=v,l-=v,e.back+=v,e.length=w,T===0){e.mode=sn;break}if(T&32){e.back=-1,e.mode=ee;break}if(T&64){t.msg="invalid literal/length code",e.mode=I;break}e.extra=T&15,e.mode=Vi;case Vi:if(e.extra){for(k=e.extra;l<k;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}e.length+=c&(1<<e.extra)-1,c>>>=e.extra,l-=e.extra,e.back+=e.extra}e.was=e.length,e.mode=en;case en:for(;b=e.distcode[c&(1<<e.distbits)-1],v=b>>>24,T=b>>>16&255,w=b&65535,!(v<=l);){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(!(T&240)){for(x=v,_=T,C=w;b=e.distcode[C+((c&(1<<x+_)-1)>>x)],v=b>>>24,T=b>>>16&255,w=b&65535,!(x+v<=l);){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}c>>>=x,l-=x,e.back+=x}if(c>>>=v,l-=v,e.back+=v,T&64){t.msg="invalid distance code",e.mode=I;break}e.offset=w,e.extra=T&15,e.mode=tn;case tn:if(e.extra){for(k=e.extra;l<k;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}e.offset+=c&(1<<e.extra)-1,c>>>=e.extra,l-=e.extra,e.back+=e.extra}if(e.offset>e.dmax){t.msg="invalid distance too far back",e.mode=I;break}e.mode=nn;case nn:if(u===0)break e;if(f=p-u,e.offset>f){if(f=e.offset-f,f>e.whave&&e.sane){t.msg="invalid distance too far back",e.mode=I;break}f>e.wnext?(f-=e.wnext,g=e.wsize-f):g=e.wnext-f,f>e.length&&(f=e.length),m=e.window}else m=n,g=a-e.offset,f=e.length;f>u&&(f=u),u-=f,e.length-=f;do n[a++]=m[g++];while(--f);e.length===0&&(e.mode=st);break;case sn:if(u===0)break e;n[a++]=e.length,u--,e.mode=st;break;case $t:if(e.wrap){for(;l<32;){if(o===0)break e;o--,c|=i[r++]<<l,l+=8}if(p-=u,t.total_out+=p,e.total+=p,p&&(t.adler=e.check=e.flags?Y(e.check,n,p,a-p):It(e.check,n,p,a-p)),p=u,(e.flags?c:cn(c))!==e.check){t.msg="incorrect data check",e.mode=I;break}c=0,l=0}e.mode=rn;case rn:if(e.wrap&&e.flags){for(;l<32;){if(o===0)break e;o--,c+=i[r++]<<l,l+=8}if(c!==(e.total&4294967295)){t.msg="incorrect length check",e.mode=I;break}c=0,l=0}e.mode=an;case an:y=Vs;break e;case I:y=$i;break e;case on:return Ri;case ir:default:return J}return t.next_out=a,t.avail_out=u,t.next_in=r,t.avail_in=o,e.hold=c,e.bits=l,(e.wsize||p!==t.avail_out&&e.mode<I&&(e.mode<$t||s!==Di))&&pn(t,t.output,t.next_out,p-t.avail_out),h-=t.avail_in,p-=t.avail_out,t.total_in+=h,t.total_out+=p,e.total+=p,e.wrap&&p&&(t.adler=e.check=e.flags?Y(e.check,n,p,t.next_out-p):It(e.check,n,p,t.next_out-p)),t.data_type=e.bits+(e.last?64:0)+(e.mode===ee?128:0)+(e.mode===nt||e.mode===Dt?256:0),(h===0&&p===0||s===Di)&&y===ge&&(y=tr),y}function dr(t){if(!t||!t.state)return J;var s=t.state;return s.window&&(s.window=null),t.state=null,ge}function fr(t,s){var e;return!t||!t.state||(e=t.state,!(e.wrap&2))?J:(e.head=s,s.done=!1,ge)}function hr(t,s){var e=s.length,i,n,r;return!t||!t.state||(i=t.state,i.wrap!==0&&i.mode!==it)?J:i.mode===it&&(n=1,n=It(n,s,e,0),n!==i.check)?$i:(r=pn(t,s,e,e),r?(i.mode=on,Ri):(i.havedict=1,ge))}j.inflateReset=un,j.inflateReset2=dn,j.inflateResetKeep=ln,j.inflateInit=cr,j.inflateInit2=fn,j.inflate=ur,j.inflateEnd=dr,j.inflateGetHeader=fr,j.inflateSetDictionary=hr,j.inflateInfo="pako inflate (from Nodeca project)";var bn={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};function pr(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var br=pr,Oe=j,Fe=Q,rt=be,z=bn,Mt=kt,_r=xi,gr=br,_n=Object.prototype.toString;function me(t){if(!(this instanceof me))return new me(t);this.options=Fe.assign({chunkSize:16384,windowBits:0,to:""},t||{});var s=this.options;s.raw&&s.windowBits>=0&&s.windowBits<16&&(s.windowBits=-s.windowBits,s.windowBits===0&&(s.windowBits=-15)),s.windowBits>=0&&s.windowBits<16&&!(t&&t.windowBits)&&(s.windowBits+=32),s.windowBits>15&&s.windowBits<48&&(s.windowBits&15||(s.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new _r,this.strm.avail_out=0;var e=Oe.inflateInit2(this.strm,s.windowBits);if(e!==z.Z_OK)throw new Error(Mt[e]);if(this.header=new gr,Oe.inflateGetHeader(this.strm,this.header),s.dictionary&&(typeof s.dictionary=="string"?s.dictionary=rt.string2buf(s.dictionary):_n.call(s.dictionary)==="[object ArrayBuffer]"&&(s.dictionary=new Uint8Array(s.dictionary)),s.raw&&(e=Oe.inflateSetDictionary(this.strm,s.dictionary),e!==z.Z_OK)))throw new Error(Mt[e])}me.prototype.push=function(t,s){var e=this.strm,i=this.options.chunkSize,n=this.options.dictionary,r,a,o,u,c,l=!1;if(this.ended)return!1;a=s===~~s?s:s===!0?z.Z_FINISH:z.Z_NO_FLUSH,typeof t=="string"?e.input=rt.binstring2buf(t):_n.call(t)==="[object ArrayBuffer]"?e.input=new Uint8Array(t):e.input=t,e.next_in=0,e.avail_in=e.input.length;do{if(e.avail_out===0&&(e.output=new Fe.Buf8(i),e.next_out=0,e.avail_out=i),r=Oe.inflate(e,z.Z_NO_FLUSH),r===z.Z_NEED_DICT&&n&&(r=Oe.inflateSetDictionary(this.strm,n)),r===z.Z_BUF_ERROR&&l===!0&&(r=z.Z_OK,l=!1),r!==z.Z_STREAM_END&&r!==z.Z_OK)return this.onEnd(r),this.ended=!0,!1;e.next_out&&(e.avail_out===0||r===z.Z_STREAM_END||e.avail_in===0&&(a===z.Z_FINISH||a===z.Z_SYNC_FLUSH))&&(this.options.to==="string"?(o=rt.utf8border(e.output,e.next_out),u=e.next_out-o,c=rt.buf2string(e.output,o),e.next_out=u,e.avail_out=i-u,u&&Fe.arraySet(e.output,e.output,o,u,0),this.onData(c)):this.onData(Fe.shrinkBuf(e.output,e.next_out))),e.avail_in===0&&e.avail_out===0&&(l=!0)}while((e.avail_in>0||e.avail_out===0)&&r!==z.Z_STREAM_END);return r===z.Z_STREAM_END&&(a=z.Z_FINISH),a===z.Z_FINISH?(r=Oe.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===z.Z_OK):(a===z.Z_SYNC_FLUSH&&(this.onEnd(z.Z_OK),e.avail_out=0),!0)},me.prototype.onData=function(t){this.chunks.push(t)},me.prototype.onEnd=function(t){t===z.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Fe.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};function Lt(t,s){var e=new me(s);if(e.push(t,!0),e.err)throw e.msg||Mt[e.err];return e.result}function mr(t,s){return s=s||{},s.raw=!0,Lt(t,s)}Ze.Inflate=me,Ze.inflate=Lt,Ze.inflateRaw=mr,Ze.ungzip=Lt;var vr=Q.assign,wr=Ae,yr=Ze,kr=bn,gn={};vr(gn,wr,yr,kr);var mn=gn,vn=ce(mn);class xr extends P{constructor(){super(...arguments);d(this,"id","HUOBI");d(this,"liquidationOrdersSubscriptions",{});d(this,"endpoints",{PRODUCTS:["https://api.huobi.pro/v1/common/symbols","https://api.hbdm.com/api/v1/contract_contract_info","https://api.hbdm.com/swap-api/v1/swap_contract_info","https://api.hbdm.com/linear-swap-api/v1/swap_contract_info"]});d(this,"contractTypesAliases",{this_week:"CW",next_week:"NW",quarter:"CQ",next_quarter:"NQ"});d(this,"types",{});d(this,"specs",{});d(this,"prices",{})}async getUrl(e){return this.types[e]==="futures"?"wss://www.hbdm.com/ws":this.types[e]==="swap"?"wss://api.hbdm.com/swap-ws":this.types[e]==="linear"?"wss://api.hbdm.com/linear-swap-ws":"wss://api.huobi.pro/ws"}formatProducts(e){const i=[],n={},r={};for(const a of e){const o=["spot","futures","swap","linear"][e.indexOf(a)];for(const u of a.data){let c;switch(o){case"spot":c=(u["base-currency"]+u["quote-currency"]).toLowerCase();break;case"futures":c=u.symbol+"_"+this.contractTypesAliases[u.contract_type],n[c]=u.contract_size;break;case"swap":case"linear":c=u.contract_code,n[c]=u.contract_size;break}if(i.find(l=>l.toLowerCase()===c.toLowerCase()))throw new Error("Duplicate pair detected on huobi exchange ("+c+")");r[c]=o,i.push(c)}}return{products:i,specs:n,types:r}}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({sub:`market.${i}.trade.detail`,id:i})),this.subscribeLiquidations(e,i),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({unsub:"market."+i+".trade.detail",id:i})),!0}onMessage(e,i){const n=JSON.parse(vn.inflate(e.data,{to:"string"}));if(n){if(n.ping){i.send(JSON.stringify({pong:n.ping}));return}else if(n.tick&&n.tick.data&&n.tick.data.length){const r=n.ch.replace(/market.(.*).trade.detail/,"$1");return this.emitTrades(i.id,n.tick.data.map(a=>this.formatTrade(a,r))),!0}}}formatTrade(e,i){let n=+e.amount;return typeof this.specs[i]=="number"&&(n=n*this.specs[i]/(this.types[i]==="linear"?1:e.price)),this.prices[i]=+e.price,{exchange:this.id,pair:i,timestamp:e.ts,price:+e.price,size:n,side:e.direction}}formatLiquidation(e,i){const n=this.prices[i]||e.price;return{exchange:this.id,pair:i,timestamp:+new Date,price:n,size:+e.amount,side:e.direction,liquidation:!0}}subscribeLiquidations(e,i,n=!1){if(e._marketDataApi&&e._marketDataApi.readyState===WebSocket.OPEN&&(this.types[i]==="futures"||this.types[i]==="swap"||this.types[i]==="linear")){const r=this.types[i]==="futures"?i.replace(/\d+/,"").replace(/(-|_).*/,""):i;e._marketDataApi.send(JSON.stringify({op:n?"unsub":"sub",topic:"public."+r+".liquidation_orders"}))}}onApiRemoved(e){e._marketDataApi&&e._marketDataApi.readyState===WebSocket.OPEN&&(console.debug(`[${this.id}] close market data api ${e._marketDataApi.url} (associated with ${e.id})`),e._marketDataApi.close())}onApiCreated(e){this.liquidationOrdersSubscriptions[e.id]=[],this.openMarketDataApi(e)}openMarketDataApi(e){e.url==="wss://api.hbdm.com/swap-ws"?e._marketDataApi=new WebSocket("wss://api.hbdm.com/swap-notification"):e.url==="wss://api.hbdm.com/linear-swap-ws"&&(e._marketDataApi=new WebSocket("wss://api.hbdm.com/linear-swap-notification")),e._marketDataApi&&(e._marketDataApi.binaryType="arraybuffer",console.debug(`[${this.id}] opened market data api ${e._marketDataApi.url} (associated with ${this.id})`),e._marketDataApi.onmessage=i=>{const n=JSON.parse(vn.inflate(i.data,{to:"string"}));if(n.op==="ping")e._marketDataApi.send(JSON.stringify({op:"pong",ts:n.ts}));else if(n.data){const r=n.topic.replace(/public.(.*).liquidation_orders/,"$1");this.emitLiquidations(e.id,n.data.map(a=>this.formatLiquidation(a,r)))}},e._marketDataApi.onopen=()=>{for(const i of e._connected)this.subscribeLiquidations(e,i)},e._marketDataApi.onerror=i=>{console.error(`[${this.id}] market data api errored ${i.message}`)},e._marketDataApi.onclose=i=>{console.error(`[${this.id}] market data api closed ${i.message}`),e._marketDataApi=null,setTimeout(()=>{e.readyState===WebSocket.OPEN&&this.openMarketDataApi(e)},1e3)})}}class Sr extends P{constructor(){super(...arguments);d(this,"id","BINANCE");d(this,"lastSubscriptionId",0);d(this,"subscriptions",{});d(this,"endpoints",{PRODUCTS:"https://data-api.binance.vision/api/v3/exchangeInfo"});d(this,"maxConnectionsPerApi",100);d(this,"delayBetweenMessages",250)}async getUrl(){return"wss://data-stream.binance.vision:9443/ws"}formatProducts(e){return e.symbols.filter(i=>i.status==="TRADING"&&i.permissions.indexOf("LEVERAGED")===-1).map(i=>i.symbol.toLowerCase())}async subscribe(e,i){if(!await super.subscribe(e,i))return;this.subscriptions[i]=++this.lastSubscriptionId;const n=N.aggregationLength===-1?"trade":"aggTrade",r=[i+"@"+n];return e.send(JSON.stringify({method:"SUBSCRIBE",params:r,id:this.subscriptions[i]})),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;const n=N.aggregationLength===-1?"trade":"aggTrade",r=[i+"@"+n];return e.send(JSON.stringify({method:"UNSUBSCRIBE",params:r,id:this.subscriptions[i]})),delete this.subscriptions[i],!0}onMessage(e,i){const n=JSON.parse(e.data);if(n.E)return this.emitTrades(i.id,[{exchange:this.id,pair:n.s.toLowerCase(),timestamp:n.T,price:+n.p,size:+n.q,count:n.l-n.f+1,side:n.m?"sell":"buy"}])}}class Tr extends P{constructor(){super(...arguments);d(this,"id","BITFINEX");d(this,"maxConnectionsPerApi",24);d(this,"channels",{});d(this,"prices",{});d(this,"endpoints",{PRODUCTS:"https://api.bitfinex.com/v1/symbols"})}async getUrl(){return"wss://api-pub.bitfinex.com/ws/2/"}formatProducts(e){return e.map(i=>i.toUpperCase())}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({event:"subscribe",channel:"trades",symbol:"t"+i})),e._connected.length===1&&e.send(JSON.stringify({event:"subscribe",channel:"status",key:"liq:global"})),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;if(e._connected.length===0){const r=Object.keys(this.channels[e._id]).find(a=>this.channels[e._id][a].name==="status");return r&&(e.send(JSON.stringify({event:"unsubscribe",chanId:r})),delete this.channels[e._id][r]),!0}const n=Object.keys(this.channels[e._id]).filter(r=>this.channels[e._id][r].pair===i);if(!n.length){console.log(`[${this}.id}/unsubscribe] no channel to unsubscribe to, but server called unsubscibr(${i}). Here is the active channels on bitfinex exchange :`,this.channels[e._id]);return}for(const r of n)e.send(JSON.stringify({event:"unsubscribe",chanId:r})),delete this.channels[e._id][r]}onMessage(e,i){const n=JSON.parse(e.data);if(n.event==="subscribed"&&n.chanId){this.channels[i._id][n.chanId]={name:n.channel,pair:n.pair};return}const r=n[0];if(!this.channels[i._id][r]||n[1]==="hb"){n[1]!=="hb"&&n.event!=="info"&&console.warn(`[${this.id}] received unknown event ${e.data}`);return}const a=this.channels[i._id][r];if(!a.hasSentInitialMessage){a.hasSentInitialMessage=!0;return}if(a.name==="trades"&&n[1]==="te")return this.prices[a.pair]=+n[2][3],this.emitTrades(i._id,[{exchange:this.id,pair:a.pair,timestamp:+new Date(n[2][1]),price:+n[2][3],size:Math.abs(n[2][2]),side:n[2][2]<0?"sell":"buy"}]);if(a.name==="status"&&n[1])return this.emitLiquidations(i._id,n[1].filter(o=>!o[8]&&!o[10]&&!o[11]&&i._connected.indexOf(o[4].substring(1))!==-1).map(o=>{const u=o[4].substring(1);return{exchange:this.id,pair:o[4].substring(1),timestamp:parseInt(o[2]),price:this.prices[u],size:Math.abs(o[5]),side:o[5]>1?"sell":"buy",liquidation:!0}}))}onApiCreated(e){this.channels[e._id]={}}onApiRemoved(e){delete this.channels[e._id]}}class Er extends P{constructor(){super(...arguments);d(this,"id","BITSTAMP");d(this,"endpoints",{PRODUCTS:"https://www.bitstamp.net/api/v2/trading-pairs-info/"})}async getUrl(){return"wss://ws.bitstamp.net/"}formatProducts(e){return e.map(i=>i.url_symbol)}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({event:"bts:subscribe",data:{channel:"live_trades_"+i}})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({event:"bts:unsubscribe",data:{channel:"live_trades_"+i}})),!0}onMessage(e,i){const n=JSON.parse(e.data);if(!n||!n.data||!n.data.amount)return;const r=n.data;return this.emitTrades(i.id,[{exchange:this.id,pair:n.channel.split("_").pop(),timestamp:+new Date(r.microtimestamp/1e3),price:r.price,size:r.amount,side:r.type===0?"buy":"sell"}])}}class Or extends P{constructor(){super(...arguments);d(this,"id","COINBASE");d(this,"endpoints",{PRODUCTS:"https://api.pro.coinbase.com/products"})}async getUrl(){return"wss://ws-feed.pro.coinbase.com/"}formatProducts(e){return e.map(i=>i.id)}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({type:"subscribe",channels:[{name:"matches",product_ids:[i]}]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({type:"unsubscribe",channels:[{name:"matches",product_ids:[i]}]})),!0}onMessage(e,i){const n=JSON.parse(e.data);if(n&&n.size>0)return this.emitTrades(i.id,[{exchange:this.id,pair:n.product_id,timestamp:+new Date(n.time),price:+n.price,size:+n.size,side:n.side==="buy"?"sell":"buy"}])}}class Ar extends P{constructor(){super(...arguments);d(this,"id","HITBTC");d(this,"endpoints",{PRODUCTS:"https://api.hitbtc.com/api/2/public/symbol"})}async getUrl(){return"wss://api.hitbtc.com/api/2/ws"}formatProducts(e){return e.map(i=>i.id)}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({method:"subscribeTrades",params:{symbol:i}})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({method:"unsubscribeTrades",params:{symbol:i}})),!0}onMessage(e,i){const n=JSON.parse(e.data);if(!(!n||n.method!=="updateTrades"||!n.params||!n.params.data||!n.params.data.length))return this.emitTrades(i.id,n.params.data.map(r=>({exchange:this.id,pair:n.params.symbol,timestamp:+new Date(r.timestamp),price:+r.price,size:+r.quantity,side:r.side})))}}class Cr extends P{constructor(){super(...arguments);d(this,"id","OKEX");d(this,"specs");d(this,"inversed");d(this,"types");d(this,"endpoints",{PRODUCTS:["https://www.okex.com/api/v5/public/instruments?instType=SPOT","https://www.okex.com/api/v5/public/instruments?instType=FUTURES","https://www.okex.com/api/v5/public/instruments?instType=SWAP"]})}async getUrl(){return"wss://ws.okex.com:8443/ws/v5/public"}validateProducts(e){return!!e.types}formatProducts(e){const i=[],n={},r={},a={},o={};for(const u of e)for(const c of u.data){const l=c.instType,h=c.instId;l==="FUTURES"?(n[h]=+c.ctVal,r[h]=c.alias,c.ctType==="inverse"&&(a[h]=!0)):l==="SWAP"&&(n[h]=+c.ctVal,c.ctType==="inverse"&&(a[h]=!0)),o[h]=l,i.push(h)}return{products:i,specs:n,aliases:r,inversed:a,types:o}}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({op:"subscribe",args:[{channel:"trades",instId:i}]})),this.types[i]!=="SPOT"&&e.send(JSON.stringify({op:"subscribe",args:[{channel:"liquidation-orders",instType:this.types[i]}]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({op:"unsubscribe",args:[{channel:"trades",instId:i}]})),this.types[i]!=="SPOT"&&e.send(JSON.stringify({op:"subscribe",args:[{channel:"liquidation-orders",instType:this.types[i]}]})),!0}formatTrade(e){let i;return typeof this.specs[e.instId]<"u"?i=e.sz*this.specs[e.instId]/(this.inversed[e.instId]?e.px:1):i=e.sz,{exchange:this.id,pair:e.instId,timestamp:+e.ts,price:+e.px,size:+i,side:e.side}}formatLiquidation(e,i){const n=e.sz*this.specs[i]/(this.inversed[i]?e.bkPx:1);return{exchange:this.id,pair:i,timestamp:+e.ts,price:+e.bkPx,size:n,side:e.side,liquidation:!0}}onMessage(e,i){const n=JSON.parse(e.data);if(!(!n||!n.data))return n.arg.channel==="liquidation-orders"?this.emitLiquidations(i.id,n.data.reduce((r,a)=>i._connected.indexOf(a.instId)===-1?r:r.concat(a.details.map(o=>this.formatLiquidation(o,a.instId))),[])):this.emitTrades(i.id,n.data.map(r=>this.formatTrade(r)))}}class Nr extends P{constructor(){super(...arguments);d(this,"id","POLONIEX");d(this,"endpoints",{PRODUCTS:"https://api.poloniex.com/markets"})}async getUrl(){return"wss://ws.poloniex.com/ws/public"}formatProducts(e){return e.map(i=>i.symbol)}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({event:"subscribe",channel:["trades"],symbols:[i]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({event:"unsubscribe",channel:["trades"],symbols:[i]})),!0}formatTrade(e){return{exchange:this.id,pair:e.symbol,timestamp:e.createTime,price:+e.price,size:e.amount/e.price,side:e.takerSide}}onMessage(e,i){const n=JSON.parse(e.data);if(!(!n||!n.data))return this.emitTrades(i.id,n.data.map(r=>this.formatTrade(r)))}onApiCreated(e){this.startKeepAlive(e,{event:"ping"},3e4)}onApiRemoved(e){this.stopKeepAlive(e)}}class Pr extends P{constructor(){super(...arguments);d(this,"id","DERIBIT");d(this,"types");d(this,"endpoints",{PRODUCTS:["https://www.deribit.com/api/v2/public/get_instruments?currency=BTC&kind=future","https://www.deribit.com/api/v2/public/get_instruments?currency=ETH&kind=future","https://www.deribit.com/api/v2/public/get_instruments?currency=USDC&kind=future"]})}async getUrl(){return"wss://www.deribit.com/ws/api/v2"}formatProducts(e){const i=[],n={};for(const r of e)for(const a of r.result)a.is_active&&(n[a.instrument_name]=a.future_type,i.push(a.instrument_name));return{products:i,types:n}}validateProducts(e){return!(!e||!e.types)}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({method:"public/subscribe",params:{channels:["trades."+i+".100ms"]}})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({method:"public/unsubscribe",params:{channels:["trades."+i+".raw"]}})),!0}onMessage(e,i){const n=JSON.parse(e.data);if(!n||!n.params||!n.params.data||!n.params.data.length)return;const r=[],a=[];for(let o=0;o<n.params.data.length;o++){const u=n.params.data[o];let c=u.amount;this.types[u.instrument_name]==="reversed"&&(c/=u.price);const l={exchange:this.id,pair:u.instrument_name,timestamp:+u.timestamp,price:+u.price,size:c,side:u.direction};u.liquidation?(l.liquidation=!0,a.push(l)):r.push(l)}return r.length&&this.emitTrades(i.id,r),a.length&&this.emitLiquidations(i.id,a),!0}onApiCreated(e){this.startKeepAlive(e,{method:"public/ping"},45e3)}onApiRemoved(e){this.stopKeepAlive(e)}}const wn=/-SPOT$/,Ir=/^publicTrade\./,yn="wss://stream.bybit.com/v5/public/spot",zr="wss://stream.bybit.com/v5/public/linear",Dr="wss://stream.bybit.com/v5/public/inverse";class $r extends P{constructor(){super(...arguments);d(this,"id","BYBIT");d(this,"types");d(this,"endpoints",{PRODUCTS:["https://api.bybit.com/v5/market/instruments-info?category=spot","https://api.bybit.com/v5/market/instruments-info?category=linear","https://api.bybit.com/v5/market/instruments-info?category=inverse"]})}async getUrl(e){return this.types[e]==="spot"?yn:this.types[e]==="linear"?zr:Dr}validateProducts(e){return!!e.types}formatProducts(e){const i=[],n={};for(const r of e){const a=["spot","linear","inverse"][e.indexOf(r)];for(const o of r.result.list){const u=`${o.symbol}${a==="spot"?"-SPOT":""}`;i.push(u),n[u]=a}}return{products:i,types:n}}async subscribe(e,i){if(!await super.subscribe(e,i))return;const n=this.types[i]==="spot",r=n?i.replace(wn,""):i,a=[`publicTrade.${r}`];return n||a.push(`liquidation.${r}`),e.send(JSON.stringify({op:"subscribe",args:a})),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;const n=this.types[i]==="spot",r=n?i.replace(wn,""):i,a=[`publicTrade.${r}`];return n||a.push(`liquidation.${r}`),e.send(JSON.stringify({op:"unsubscribe",args:a})),!0}formatTrade(e,i){let n=+e.v,r=e.s;return!i&&this.types[e.s]==="inverse"?n/=e.p:i&&(r+="-SPOT"),{exchange:this.id,pair:r,timestamp:+e.T,price:+e.p,size:n,side:e.S==="Buy"?"buy":"sell"}}formatLiquidation(e){let i=+e.size;return this.types[e.symbol]==="inverse"&&(i/=e.price),{exchange:this.id,pair:e.symbol,timestamp:+e.updatedTime,size:i,price:+e.price,side:e.side==="Buy"?"sell":"buy",liquidation:!0}}onMessage(e,i){const n=JSON.parse(e.data);if(!(!n.data||!n.topic)&&n.data.length)if(Ir.test(n.topic)){const r=i.url===yn;return this.emitTrades(i.id,n.data.map(a=>this.formatTrade(a,r)))}else return this.emitLiquidations(i.id,n.data.map(r=>this.formatLiquidation(r)))}onApiCreated(e){this.startKeepAlive(e,{op:"ping"},2e4)}onApiRemoved(e){this.stopKeepAlive(e)}}class Rr extends P{constructor(){super(...arguments);d(this,"id","PHEMEX");d(this,"leverages",[]);d(this,"currencies",[]);d(this,"riskLimits",[]);d(this,"specs",{});d(this,"endpoints",{PRODUCTS:"https://api.phemex.com/exchange/public/cfg/v2/products"});d(this,"channels",{})}async getUrl(){return"wss://phemex.com/ws"}formatProducts(e){const i={},n=[],r=e.data.leverages,a=e.data.currencies,o=e.data.riskLimits;for(const u of e.data.products){if(u.type==="Perpetual"){const c=a.find(h=>h.currency===u.quoteCurrency),l=a.find(h=>h.currency===u.settleCurrency);i[u.symbol]={type:u.type,contractSize:u.contractSize,settleCurrency:u.settleCurrency,quoteCurrency:u.quoteCurrency,valueScale:l?l.valueScale:1,priceScale:c?c.valueScale:1,ratioScale:e.data.ratioScale,riskLimits:o.filter(h=>h.symbol===u.symbol).map(h=>({steps:h.steps,riskLimits:h.riskLimits})),minPriceEp:u.minPricEp,maxPriceEp:u.maxPriceEp,lotSize:u.lotSize,pricePrecision:u.pricePrecision,maxOrderQty:u.maxOrderQty}}else if(u.type==="Spot"){const c=a.find(h=>h.currency===u.quoteCurrency),l=a.find(h=>h.currency===u.baseCurrency);i[u.symbol]={type:u.type,maxBaseOrderSizeEv:u.maxBaseOrderSizeEv,minOrderValueEv:u.minOrderValueEv,valueScale:c?c.valueScale:1,priceScale:l?l.valueScale:1,ratioScale:e.data.ratioScale}}n.push(u.symbol)}return{specs:i,products:n,leverages:r,currencies:a,riskLimits:o}}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({id:1234,method:"trade.subscribe",params:[i]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({id:1234,method:"trade.unsubscribe",params:[i]})),!0}onMessage(e,i){const n=JSON.parse(e.data);if(n.trades!==void 0&&n.type==="incremental"){const r=this.specs[n.symbol].type,a=n.trades.map(o=>{const u={exchange:this.id,pair:n.symbol,timestamp:o[0]/1e6,side:o[1]==="Buy"?"buy":"sell",price:0,size:0};return r==="Perpetual"?(u.price=+(o[2]/Math.pow(10,this.specs[n.symbol].priceScale)),u.size=+(o[3]*this.specs[n.symbol].contractSize),this.specs[n.symbol].settleCurrency!==this.specs[n.symbol].quoteCurrency&&(u.size/=u.price)):r==="Spot"&&(u.price=+(o[2]/Math.pow(10,this.specs[n.symbol].priceScale)),u.size=+(o[3]/Math.pow(10,this.specs[n.symbol].valueScale))),u});return this.emitTrades(i.id,a)}else return}onApiCreated(e){this.startKeepAlive(e,{method:"server.ping",id:9e3,params:[]},5e3)}onApiRemoved(e){this.stopKeepAlive(e)}}class Br extends P{constructor(){super(...arguments);d(this,"id","DYDX");d(this,"endpoints",{PRODUCTS:"https://api.dydx.exchange/v3/markets"})}async getUrl(){return"wss://api.dydx.exchange/v3/ws"}formatProducts(e){return Object.keys(e.markets)}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({type:"subscribe",channel:"v3_trades",id:i})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({type:"unsubscribe",channel:"v3_trades",id:i})),!0}formatTrade(e,i){return{exchange:this.id,pair:i,timestamp:+new Date(e.createdAt),price:+e.price,size:+e.size,side:e.side==="BUY"?"buy":"sell"}}onMessage(e,i){const n=JSON.parse(e.data);if(n.channel==="v3_trades"){if(n.type==="subscribed")return;const r=[],a=[];for(let o=0;o<n.contents.trades.length;o++){const u=this.formatTrade(n.contents.trades[o],n.id);n.contents.trades[o].liquidation?(u.liquidation=!0,a.push(u)):r.push(u)}return r.length&&this.emitTrades(i.id,r),a.length&&this.emitLiquidations(i.id,a),!0}}}class Mr extends P{constructor(){super(...arguments);d(this,"id","UNISWAP");d(this,"endpoints",{PRODUCTS:{url:"https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v3",method:"POST",proxy:!1,data:`{"query":"
          {
                pools(first: 1000, orderBy: volumeUSD, orderDirection: desc){
                  id
                  volumeUSD
                  token0 {
                    symbol 
                  }   
                  token1 {
                    symbol 
                  }    
            }
        }
      "}`.replace(/\n/g,"\\n")}});d(this,"pools");d(this,"activePools",[]);d(this,"refreshingPools",!1);d(this,"refreshIndex",0)}async getUrl(){return null}formatProducts(e){const i=[],n={};for(const r of e.data.pools){const a=r.token0.symbol+r.token1.symbol;i.indexOf(a)===-1&&(n[a]=r.id,i.push(a))}return{products:i,pools:n}}async subscribe(e,i){const n=this.pools[i];return this.activePools.findIndex(a=>a.id===n)===-1&&(this.emit("subscribed",i),this.activePools.push({id:n,pair:i}),this.refreshingPools||this.refreshNextPool()),!0}async unsubscribe(e,i){const n=this.pools[i],r=this.activePools.findIndex(a=>a.id===n);return r!==-1&&(this.emit("unsubscribed",i),this.activePools.splice(r,1)),!0}formatTrade(e,i){const n=Math.abs(+i.amount1),r=+i.amount1>0?"buy":"sell";return{exchange:this.id,pair:e.pair,timestamp:+i.timestamp*1e3,price:+((+i.sqrtPriceX96/2**96)**2).toFixed(6),size:n,side:r}}async refreshNextPool(){if(!this.activePools.length){this.refreshingPools=!1;return}setTimeout(this.refreshNextPool.bind(this),Math.max(1e3,15e3/this.activePools.length));const e=this.activePools[this.refreshIndex++%this.activePools.length];this.refreshingPools=!0;const{data:i}=await fetch("https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v3",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`{
            swaps(orderBy: timestamp, orderDirection: desc, where: {
              pool: "${e.id}"
              ${e.timestamp?`timestamp_gt: ${e.timestamp}`:""}
            }) {
              id
              amount1
              sqrtPriceX96
              timestamp
            }
          }`})}).then(n=>n.json());if(i.swaps.length){e.timestamp=+i.swaps[0].timestamp;const n=[];for(let r=i.swaps.length-1;r>=0;r--)n.push(this.formatTrade(e,i.swaps[r]));this.emitTrades(null,n)}}async resolveApi(e){await this.subscribe(null,e)}async unlink(e){await this.unsubscribe(null,e.replace(/[^:]*:/,""))}}class Lr extends P{constructor(){super(...arguments);d(this,"id","KUCOIN");d(this,"endpoints",{PRODUCTS:["https://api.kucoin.com/api/v1/symbols","https://api-futures.kucoin.com/api/v1/contracts/active"]});d(this,"multipliers",{})}getUrl(){return this.endpoints.WS?this.endpoints.WS:fetch("https://cors.aggr.trade/https://api.kucoin.com/api/v1/bullet-public",{method:"POST"}).then(e=>e.json()).then(e=>(this.endpoints.WS="wss://ws-api.kucoin.com/endpoint",e.data.instanceServers.length&&(this.endpoints.WS=e.data.instanceServers[0].endpoint),this.endpoints.WS+="?token="+e.data.token,this.endpoints.WS)).catch(e=>{console.log(e)})}formatProducts(e){const i=[],n={};for(const r of e){const a=["spot","futures"][e.indexOf(r)];for(const o of r.data){const u=o.symbolName||o.symbol;i.push(o.symbol),a==="futures"&&(n[u]=o.multiplier)}}return{products:i,multipliers:n}}async subscribe(e,i){if(!await super.subscribe(e,i))return;let n;return this.multipliers[i]?n=`/contractMarket/execution:${i}`:n=`/market/match:${i}`,e.send(JSON.stringify({type:"subscribe",topic:n})),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;let n;return this.multipliers[i]?n=`/contractMarket/execution:${i}`:n=`/market/match:${i}`,e.send(JSON.stringify({type:"unsubscribe",topic:n})),!0}formatTrade(e){let i,n;return this.multipliers[e.symbol]?(i=e.ts/1e6,this.multipliers[e.symbol]<0?n=e.size/e.price:n=e.size*this.multipliers[e.symbol]):(i=e.time/1e6,n=+e.size),{exchange:this.id,pair:e.symbol,price:+e.price,side:e.side==="buy"?"buy":"sell",timestamp:i,size:n}}onMessage(e,i){const n=JSON.parse(e.data);if(!(!n||!n.data))return this.emitTrades(i.id,[this.formatTrade(n.data)])}onApiCreated(e){this.startKeepAlive(e,{type:"ping"},18e3)}onApiRemoved(e){this.stopKeepAlive(e)}}class Ur extends P{constructor(){super(...arguments);d(this,"id","BITGET");d(this,"endpoints",{PRODUCTS:["https://api.bitget.com/api/spot/v1/public/products","https://api.bitget.com/api/mix/v1/market/contracts?productType=umcbl","https://api.bitget.com/api/mix/v1/market/contracts?productType=dmcbl","https://api.bitget.com/api/mix/v1/market/contracts?productType=cmcbl"]});d(this,"delayBetweenMessages",150);d(this,"types",{})}async getUrl(e){return this.types[e]==="spot"?"wss://ws.bitget.com/spot/v1/stream":"wss://ws.bitget.com/mix/v1/stream"}formatProducts(e){const i=[],n={};for(const r of e){const a=["spot","umcbl","dmcbl","cmcbl"][e.indexOf(r)];for(const o of r.data){let u;a==="spot"?u=o.symbolName:u=o.symbol,i.push(u),n[u]=a}}return{products:i,types:n}}async subscribe(e,i){if(await super.subscribe(e,i))return e.send(JSON.stringify({op:"subscribe",args:[{instType:this.types[i]==="spot"?"sp":"mc",channel:"trade",instId:i.replace(/_.*/,"")}]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return e.send(JSON.stringify({op:"unsubscribe",args:[{instType:this.types[i]==="spot"?"sp":"mc",channel:"trade",instId:i.replace(/_.*/,"")}]})),!0}formatTrade(e,i){return{exchange:this.id,pair:i,timestamp:+e[0],price:+e[1],size:+e[2],side:e[3]}}onMessage(e,i){if(e.data==="pong")return;const n=JSON.parse(e.data);if(n.action==="update"&&n.data.length)return n.arg.instType==="mc"&&(/USDT$/.test(n.arg.instId)?n.arg.instId+="_UMCBL":/USD$/.test(n.arg.instId)?n.arg.instId+="_DMCBL":/PERP$/.test(n.arg.instId)&&(n.arg.instId+="_CMCBL")),this.emitTrades(i.id,n.data.map(r=>this.formatTrade(r,n.arg.instId)))}onApiCreated(e){this.startKeepAlive(e,"ping",3e4)}onApiRemoved(e){this.stopKeepAlive(e)}}class Zr extends P{constructor(){super(...arguments);d(this,"id","MEXC");d(this,"endpoints",{PRODUCTS:["https://api.mexc.com/api/v3/exchangeInfo","https://contract.mexc.com/api/v1/contract/detail"]});d(this,"delayBetweenMessages",150);d(this,"contractSizes",{});d(this,"inversed",{})}async getUrl(e){return typeof this.contractSizes[e]=="number"?"wss://contract.mexc.com/ws":"wss://wbs.mexc.com/ws"}formatProducts(e){const i=[],n={},r={},[a,o]=e;if(a)for(const u of a.symbols)i.push(u.symbol);if(o)for(const u of o.data)i.push(u.symbol),n[u.symbol]=u.contractSize,r[u.symbol]=u.quoteCoin===u.settleCoin;return{products:i,inversed:r,contractSizes:n}}async subscribe(e,i){if(await super.subscribe(e,i))return typeof this.contractSizes[i]=="number"?e.send(JSON.stringify({method:"sub.deal",param:{symbol:i}})):e.send(JSON.stringify({method:"SUBSCRIPTION",params:[`spot@public.deals.v3.api@${i}`]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return typeof this.contractSizes[i]<"u"?e.send(JSON.stringify({method:"unsub.deal",param:{symbol:i}})):e.send(JSON.stringify({method:"UNSUBSCRIPTION",params:[`spot@public.deals.v3.api@${i}`]})),!0}formatSpotTrade(e,i){return{exchange:this.id,pair:i,timestamp:e.t,price:+e.p,size:+e.v,side:e.S===1?"buy":"sell"}}formatContractTrade(e,i){return{exchange:this.id,pair:i,timestamp:e.t,price:e.p,size:e.v*this.contractSizes[i]/(this.inversed[i]?1:e.p),side:e.T===1?"buy":"sell"}}onMessage(e,i){const n=JSON.parse(e.data);if(n.channel==="push.deal")return this.emitTrades(i.id,[this.formatContractTrade(n.data,n.symbol)]);if(n.d&&n.d.e==="spot@public.deals.v3.api")return this.emitTrades(i.id,n.d.deals.map(r=>this.formatSpotTrade(r,n.s)))}onApiCreated(e){this.startKeepAlive(e,{method:/contract/.test(e.url)?"ping":"PING"},15e3)}onApiRemoved(e){this.stopKeepAlive(e)}}class Jr extends P{constructor(){super(...arguments);d(this,"id","GATEIO");d(this,"endpoints",{PRODUCTS:["https://api.gateio.ws/api/v4/spot/currency_pairs","https://api.gateio.ws/api/v4/futures/usdt/contracts"]});d(this,"types",{});d(this,"multipliers",{})}async getUrl(e){if(this.types[e]==="spot")return"wss://ws.gate.io/v3/";if(this.types[e]==="futures")return"wss://fx-ws.gateio.ws/v4/ws/usdt"}formatProducts(e){const i=[],n={},r={};return e.forEach((a,o)=>{const u=["spot","futures"][o];a.forEach(c=>{let l;switch(u){case"spot":l=c.id+"_SPOT",n[l]=parseFloat(c.min_base_amount);break;case"futures":l=c.name+"_FUTURES",n[l]=parseFloat(c.quanto_multiplier);break}if(i.find(h=>h.toLowerCase()===l.toLowerCase()))throw new Error("Duplicate pair detected on gateio exchange ("+l+")");r[l]=u,i.push(l)})}),{products:i,multipliers:n,types:r}}async subscribe(e,i){if(await super.subscribe(e,i))return this.types[i]==="spot"?e.send(JSON.stringify({method:"trades.subscribe",params:[i.split("_").slice(0,2).join("_")]})):this.types[i]==="futures"&&e.send(JSON.stringify({time:Date.now(),channel:`${this.types[i]}.trades`,event:"subscribe",payload:[i.split("_").slice(0,2).join("_")]})),!0}async unsubscribe(e,i){if(await super.unsubscribe(e,i))return this.types[i]==="spot"?e.send(JSON.stringify({method:"trades.unsubscribe",params:[i.split("_").slice(0,2).join("_")]})):this.types[i]==="futures"&&e.send(JSON.stringify({time:Date.now(),channel:`${this.types[i]}.trades`,event:"unsubscribe",payload:[i.split("_").slice(0,2).join("_")]})),!0}onMessage(e,i){const n=JSON.parse(e.data);if(!n)return;let r=[];if(n.channel&&n.channel.endsWith(".trades")&&n.event&&n.event==="update"&&n.result&&n.result.length)r=n.result.map(a=>{const o=n.channel.split(".")[0].toUpperCase();return a={exchange:this.id,pair:a.contract+"_"+o,timestamp:+new Date(a.create_time_ms),price:+a.price,size:+(Math.abs(a.size)*this.multipliers[a.contract+"_"+o]),side:a.size>0?"buy":"sell"},a});else if(n.method&&n.method==="trades.update"&&n.params&&Array.isArray(n.params)){const[a,o]=n.params;r=o.map(u=>({exchange:this.id,pair:a+"_SPOT",timestamp:+new Date(parseInt((u.time*1e3).toString().split(".")[0])),price:+u.price,size:+u.amount,side:u.type}))}return this.emitTrades(i.id,r)}}class Fr extends P{constructor(){super(...arguments);d(this,"id","CRYPTOCOM");d(this,"endpoints",{PRODUCTS:"https://api.crypto.com/exchange/v1/public/get-instruments"})}async getUrl(){return"wss://stream.crypto.com/v2/market"}formatProducts(e){return e.result.data.map(i=>i.symbol)}async subscribe(e,i){if(!await super.subscribe(e,i))return;const n={channels:[`trade.${i}`]};return e.send(JSON.stringify({method:"subscribe",params:n,id:Date.now()})),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;const n={channels:[`trade.${i}`]};return e.send(JSON.stringify({method:"unsubscribe",params:n,id:Date.now()})),!0}onMessage(e,i){const n=JSON.parse(e.data);if(n.result)return this.emitTrades(i.id,n.result.data.map(r=>this.formatResponse(r)))}formatResponse(e){return{exchange:this.id,pair:e.i,timestamp:+new Date(e.t),price:+e.p,size:+e.q,side:e.s.toLowerCase()}}}class jr extends P{constructor(){super(...arguments);d(this,"id","BITMART");d(this,"endpoints",{PRODUCTS:["https://api-cloud.bitmart.com/spot/v1/symbols/details","https://api-cloud.bitmart.com/contract/public/details"]});d(this,"specs",{})}async getUrl(e){return this.specs[e]?"wss://openapi-ws.bitmart.com/api?protocol=1.1":"wss://ws-manager-compress.bitmart.com/api?protocol=1.1"}validateProducts(e){return!!e.specs}formatProducts(e){const i=[],n={},r={};for(const a of e)for(const o of a.data.symbols)i.push(o.symbol),o.contract_size&&(n[o.symbol]=+o.contract_size);return{products:i,specs:n,types:r}}async subscribe(e,i){if(!await super.subscribe(e,i))return;const r=!!this.specs[i]?{prefix:"futures",arg:"action"}:{prefix:"spot",arg:"op"};return e.send(JSON.stringify({[r.arg]:"subscribe",args:[`${r.prefix}/trade:${i}`]})),!0}async unsubscribe(e,i){if(!await super.unsubscribe(e,i))return;const r=!!this.specs[i]?{prefix:"futures",arg:"action"}:{prefix:"spot",arg:"op"};return e.send(JSON.stringify({[r.arg]:"unsubscribe",args:[`${r.prefix}/trade:${i}`]})),!0}formatTrade(e){return this.specs[e.symbol]?{exchange:this.id,pair:e.symbol,timestamp:e.create_time_mill,price:+e.deal_price,size:e.deal_vol*this.specs[e.symbol]/(this.specs[e.symbol]>1?e.deal_price:1),side:e.way<4?"buy":"sell"}:{exchange:this.id,pair:e.symbol,timestamp:e.s_t*1e3,price:+e.price,size:+e.size,side:e.side}}onMessage(e,i){let n=e.data;typeof n!="string"&&(n=mn.inflateRaw(e.data,{to:"string"}));const r=JSON.parse(n);if(!(!r||!r.data))return this.emitTrades(i.id,r.data.map(a=>this.formatTrade(a)))}}const at=[new On,new An,new Cn,new Nn,new Pn,new xr,new Sr,new Tr,new Er,new Or,new Ar,new Cr,new Nr,new Pr,new $r,new Rr,new Br,new Mr,new Lr,new Ur,new Zr,new Jr,new Fr,new jr];function ot(t){for(const s of at)if(s.id.toLowerCase()===t.toLowerCase())return s}class qr{constructor(s){d(this,"ctx");d(this,"connections",{});d(this,"activeBuckets",[]);d(this,"buckets",{});d(this,"connectionsCount",0);d(this,"connectionChange",0);d(this,"tickersDelay",10);d(this,"baseAggregationTimeout",50);d(this,"onGoingAggregations",{});d(this,"aggregationTimeouts",{});d(this,"pendingTrades",[]);d(this,"tickers",{});d(this,"_connectionChangeNoticeTimeout");this.bindExchanges(),this.startTickersInterval(),this.ctx=s,this.ctx.postMessage({op:"hello"})}bindExchanges(){for(const s of at)s.on("subscribed",this.onSubscribed.bind(this,s.id)),s.on("unsubscribed",this.onUnsubscribed.bind(this,s.id)),s.on("error",this.onError.bind(this,s.id))}bindTradesEvent(){for(const s of at)s.off("trades"),s.off("liquidations"),N.aggregationLength>0?(s.on("trades",this.aggregateTrades.bind(this)),s.on("liquidations",this.aggregateLiquidations.bind(this))):(s.on("trades",this.emitTrades.bind(this)),s.on("liquidations",this.emitLiquidations.bind(this)));N.aggregationLength>0?(this.startAggrInterval(),console.debug("[worker] bind trades: aggregation")):(this.clearInterval("aggr"),this.timeoutExpiredAggregations(),this.emitPendingTrades(),console.debug("[worker] bind trades: simple"))}updateBuckets(s){const e=[],i=[];s.length&&(console.log("[worker] update buckets using :",s),console.debug("[worker] previous buckets :",{...this.buckets},this.activeBuckets));for(const n in s){e.indexOf(n)===-1&&e.push(n),this.buckets[n]||(console.debug("[worker] create bucket",n),this.buckets[n]=this.createBucket());for(const r of s[n]){if(i.indexOf(r)===-1&&i.push(r),!this.connections[r]){console.warn("attempted to activate bucket on inexistant connection",r);continue}this.connections[r].bucket||(console.debug("[worker] create market bucket",r),this.connections[r].bucket=this.createBucket())}}for(const n in this.connections)this.connections[n].bucket&&i.indexOf(n)===-1&&(console.log("[worker] remove market bucket",n),this.connections[n].bucket=null);for(const n in this.buckets)e.indexOf(n)===-1&&(console.log("[worker] remove bucket",n),delete this.buckets[n]);e.length&&console.log("[worker] finished updating buckets (active buckets: ",e,")"),e.length&&!this.activeBuckets.length?this.startStatsInterval():this.activeBuckets.length&&!e.length&&this._statsInterval&&(this.clearInterval("stats"),this._statsInterval=null,console.debug("[worker] stopped statsInterval timer")),this.activeBuckets=e,N.buckets=s}emitTrades(s){for(let e=0;e<s.length;e++){const i=s[e],n=i.exchange+":"+i.pair;this.connections[n]&&(N.calculateSlippage&&(i.originalPrice=this.tickers[n].price||i.price),i.count=i.count||1,this.processTrade(i))}this.ctx.postMessage({op:"trades",data:s})}aggregateTrades(s){const e=Date.now();for(let i=0;i<s.length;i++){const n=s[i],r=n.exchange+":"+n.pair;if(this.connections[r]){if(this.onGoingAggregations[r]){const a=this.onGoingAggregations[r];if(a.timestamp+N.aggregationLength>n.timestamp&&a.side===n.side){a.size+=n.size,a.price=n.price,a.count+=n.count||1;continue}else this.pendingTrades.push(this.processTrade(a))}n.originalPrice=this.tickers[r].price||n.price,n.count=n.count||1,this.aggregationTimeouts[r]=e+this.baseAggregationTimeout,this.onGoingAggregations[r]=n}}}emitLiquidations(s){for(let e=0;e<s.length;e++){const i=s[e],n=i.exchange+":"+i.pair;this.connections[n]&&this.processLiquidation(i)}this.ctx.postMessage({op:"trades",data:s})}aggregateLiquidations(s){const e=Date.now();for(let i=0;i<s.length;i++){const n=s[i],r=n.exchange+":"+n.pair,a="liq_"+r;if(this.connections[r]){if(this.onGoingAggregations[a]){const o=this.onGoingAggregations[a];if(N.aggregationLength>0&&o.timestamp+N.aggregationLength>n.timestamp&&o.side===n.side){o.size+=n.size,o.count++;continue}else this.pendingTrades.push(this.processLiquidation(o))}n.count=1,this.aggregationTimeouts[a]=e+this.baseAggregationTimeout,this.onGoingAggregations[a]=n}}}processTrade(s){const e=s.exchange+":"+s.pair;return N.calculateSlippage&&(N.calculateSlippage==="price"?(s.slippage=Math.round((s.price-s.originalPrice+Number.EPSILON)*10)/10,Math.abs(s.slippage)/s.price<25e-5&&(s.slippage=null)):N.calculateSlippage==="bps"&&(s.side==="buy"?s.slippage=Math.floor((s.price-s.originalPrice)/s.originalPrice*1e4):s.slippage=Math.floor((s.originalPrice-s.price)/s.price*1e4))),s.amount=(N.preferQuoteCurrencySize?s.price:1)*s.size,this.tickers[e].updated=!0,this.tickers[e].volume+=s.amount,this.tickers[e].volumeDelta+=s.amount*(s.side==="buy"?1:-1),this.tickers[e].price=s.price,this.tickers[e].initialPrice===null&&this.emitInitialPrice(e,s.price),N.aggregationLength>0&&(s.price=Math.max(s.price,s.originalPrice)),this.connections[e].bucket&&(this.connections[e].bucket["c"+s.side]+=s.count,this.connections[e].bucket["v"+s.side]+=s.amount),s}processLiquidation(s){const e=s.exchange+":"+s.pair;return s.amount=(N.preferQuoteCurrencySize?s.price:1)*s.size,this.connections[e].bucket&&(this.connections[e].bucket["l"+s.side]+=s.amount),s}timeoutExpiredAggregations(){const s=Date.now(),e=Object.keys(this.onGoingAggregations);for(let i=0;i<e.length;i++){const n=this.onGoingAggregations[e[i]];s>this.aggregationTimeouts[e[i]]&&(n.liquidation?this.pendingTrades.push(this.processLiquidation(n)):this.pendingTrades.push(this.processTrade(n)),delete this.onGoingAggregations[e[i]])}}emitInitialPrice(s,e){this.tickers[s].initialPrice=e,this.ctx.postMessage({op:"price",data:{market:s,price:e}})}emitPendingTrades(){N.aggregationLength>0&&this.timeoutExpiredAggregations(),this.pendingTrades.length&&(this.ctx.postMessage({op:"trades",data:this.pendingTrades}),this.pendingTrades.splice(0,this.pendingTrades.length))}emitStats(){const s=Date.now();for(const e in N.buckets){for(const i of N.buckets[e])this.connections[i]&&(this.buckets[e].vbuy+=this.connections[i].bucket.vbuy,this.buckets[e].vsell+=this.connections[i].bucket.vsell,this.buckets[e].cbuy+=this.connections[i].bucket.cbuy,this.buckets[e].csell+=this.connections[i].bucket.csell,this.buckets[e].lbuy+=this.connections[i].bucket.lbuy,this.buckets[e].lsell+=this.connections[i].bucket.lsell);this.buckets[e].timestamp=s,this.ctx.postMessage({op:"bucket-"+e,data:this.buckets[e]}),this.clearBucket(this.buckets[e])}for(const e in this.connections)this.connections[e].bucket&&this.clearBucket(this.connections[e].bucket)}emitTickers(){if(this.connectionsCount){const s={};for(const e in this.tickers)this.tickers[e].updated&&(s[e]={price:this.tickers[e].price,volume:this.tickers[e].volume,volumeDelta:this.tickers[e].volumeDelta},this.tickers[e].updated=!1,this.tickers[e].volume=0,this.tickers[e].volumeDelta=0);this.ctx.postMessage({op:"tickers",data:s})}this._tickersInterval=self.setTimeout(()=>this.emitTickers(),this.tickersDelay)}onSubscribed(s,e,i){const n=s+":"+e;if(!this.connections[n]){this.connections[n]={exchange:s,pair:e,hit:0,timestamp:null},this.tickers[n]={volume:0,volumeDelta:0,initialPrice:null,price:null},this.connectionsCount=Object.keys(this.connections).length;for(const r in N.buckets)if(N.buckets[r].indexOf(n)!==-1){console.debug(`[worker] create bucket for new connection ${n}`),this.connections[n].bucket=this.createBucket();break}this.ctx.postMessage({op:"connection",data:{pair:e,url:i,exchangeId:s}}),this.noticeConnectionChange(1),this.refreshTickersDelay()}}onUnsubscribed(s,e){const i=s+":"+e;this.onGoingAggregations[i]&&delete this.onGoingAggregations[i],this.connections[i]&&(delete this.connections[i],delete this.tickers[i],this.connectionsCount=Object.keys(this.connections).length,this.ctx.postMessage({op:"disconnection",data:{pair:e,exchangeId:s}}),this.noticeConnectionChange(-1),this.refreshTickersDelay())}noticeConnectionChange(s){this.connectionChange+=s,this._connectionChangeNoticeTimeout&&clearTimeout(this._connectionChangeNoticeTimeout),this._connectionChangeNoticeTimeout=setTimeout(()=>{this._connectionChangeNoticeTimeout=null,this.connectionChange&&this.ctx.postMessage({op:"notice",data:{id:"connections",type:"success",title:this.connectionsCount+" connections ("+(this.connectionChange>0?"+":"")+this.connectionChange+")"}}),this.connectionChange=0},3e3)}createBucket(){return{timestamp:null,vbuy:0,vsell:0,cbuy:0,csell:0,lbuy:0,lsell:0}}clearBucket(s){s.cbuy=s.csell=s.vbuy=s.vsell=s.lbuy=s.lsell=0}onError(s,e){let i;typeof e=="string"?i=e:e.message&&(i=e.message),i&&this.ctx.postMessage({op:"notice",data:{id:s+"-error",type:"error",title:`${s} disconnected unexpectedly (${i})`}});const n=e&&e.target;this.ctx.postMessage({op:"error",data:{exchangeId:s,wasOpened:n?n._wasOpened:null,originalUrl:n?n._originalUrl:null,wasErrored:n?n._wasErrored:null,url:n?n.url:null}})}async connect(s,e){console.log("[aggregator] connect",s);const i=s.reduce((r,a)=>{const[o,u]=Zt(a);return!o||!u?{}:(r[o]||(r[o]=[]),r[o].indexOf(a)===-1&&r[o].push(a),r)},{}),n=[];for(const r in i){const a=ot(r);if(a){a.requiresProducts&&await a.getProducts();const o=a.getEstimatedTimeToConnect(i[r].length);o>1e3*20&&this.ctx.postMessage({op:"notice",data:{id:r+"-connection-delay",type:"warning",timeout:o,title:`Connecting to ${i[r].length} markets on ${r}
This will take about ${Tn(o,void 0," and ")}`}}),n.push((async()=>{for(const u of i[r])try{await a.link(u)}catch(c){console.error(c)}})())}else console.error(`[worker.connect] unknown exchange ${r}`)}await Promise.all(n),e&&this.ctx.postMessage({op:"connect",trackingId:e})}async disconnect(s,e){console.log("[aggregator] disconnect",s);const i=s.reduce((r,a)=>{const[o,u]=Zt(a);return!o||!u?{}:(r[o]||(r[o]=[]),r[o].indexOf(a)===-1&&r[o].push(a),r)},{}),n=[];for(const r in i){const a=ot(r);a&&n.push((async()=>{for(const o of i[r])await a.unlink(o)})())}await Promise.all(n),e&&this.ctx.postMessage({op:"connect",trackingId:e})}startTickersInterval(){this._tickersInterval||this.emitTickers()}startAggrInterval(){this._aggrInterval||(this._aggrInterval=self.setInterval(this.emitPendingTrades.bind(this),50))}startStatsInterval(){this._statsInterval||(this._statsInterval=self.setInterval(this.emitStats.bind(this),500))}clearInterval(s){this["_"+s+"Interval"]&&(clearInterval(this["_"+s+"Interval"]),this["_"+s+"Interval"]=null)}async fetchExchangeProducts({exchangeId:s,forceFetch:e},i){const n=await ot(s).getProducts(e);this.ctx.postMessage({op:"fetchExchangeProducts",data:n,trackingId:i})}formatExchangeProducts({exchangeId:s,response:e},i){let n=null;try{n=ot(s).formatProducts(e)}catch(r){console.error(r.message),this.ctx.postMessage({op:"notice",data:{id:s+"-products",type:"error",title:`Failed to format ${s}'s products`}})}this.ctx.postMessage({op:"formatExchangeProducts",data:n,trackingId:i})}configureAggregator({key:s,value:e}){if(!(typeof N[s]>"u"||N[s]===e)&&(N[s]=e,s==="aggregationLength")){const i=(this.baseAggregationTimeout||1)*(e||1)<0;if(this.baseAggregationTimeout=e,this.bindTradesEvent(),i){const n=e===-1?"raw":"aggregated",r=[];at.forEach(a=>{(a.id==="BINANCE"||a.id==="BINANCE_FUTURES")&&a.apis.length&&(r.push(a.id),a.apis.forEach(o=>o.close()))}),r.length&&this.ctx.postMessage({op:"notice",data:{title:`Switching to  ${n} trade data${r.map(a=>`<div class="d-flex mt4"><i class="icon-${a} -center mr4"></i> ${a}</div>`).join("")}`,html:!0}})}}}refreshTickersDelay(){const s=Object.keys(this.connections).length;return this.tickersDelay=Math.log(Math.exp(s/20+1)*200)*100,this.tickersDelay}getAllTickers(s,e){this.ctx.postMessage({op:"getAllTickers",trackingId:e,data:this.tickers})}}addEventListener("message",t=>{const s=t.data;typeof kn[s.op]=="function"&&kn[s.op](s.data,s.trackingId)});const kn=new qr(self)})();

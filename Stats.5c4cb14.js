var d=Object.defineProperty;var p=(r,e,t)=>e in r?d(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var i=(r,e,t)=>(p(r,typeof e!="symbol"?e+"":e,t),t);import{I as l,a2 as _,ad as f,l as k,ab as m,j as c,g as b,Y as g,d as C,ae as v,C as y,n as S,_ as T}from"./index.5c4cb14.js";import{d as I,i as u,j as E,t as O,Z as w,u as B}from"./options.5c4cb14.js";import{P as $,a as D}from"./PaneHeader.5c4cb14.js";class P{constructor(e,t,s){i(this,"id");i(this,"name");i(this,"window");i(this,"precision");i(this,"color");i(this,"granularity");i(this,"type");i(this,"stacks",[]);i(this,"timestamp");i(this,"live");i(this,"filled",!1);i(this,"remaining",0);i(this,"adapter");i(this,"serie");i(this,"timeouts",[]);this.id=t.id,this.name=t.name,this.adapter=this.getAdapter(e),this.window=(isNaN(t.window)?l.state[s].window:+t.window)||6e4,this.precision=t.precision,this.color=this.parseColor(t.color),this.granularity=Math.max(l.state[s].granularity,this.window/5e3),this.type=t.type||"line";const a=_(this.window).replace(/^1(\w)$/,"$1");this.name+="/"+a,this.clear()}getAdapter(e){const t=e.replace(/([^.]|^)(vbuy|vsell|cbuy|csell|lbuy|lsell)/g,"$1stats.$2");return new Function("stats",`'use strict'; return ${t};`)}clear(){this.stacks=[],this.live=0,this.filled=!1,this.remaining=0;for(let e=0;e<this.timeouts.length;e++)clearTimeout(this.timeouts[e]);this.timeouts=[]}unbind(){this.clear()}onStats(e){const t=this.adapter(e);if(!this.stacks.length||e.timestamp>this.timestamp+this.granularity)this.appendStack(e.timestamp);else if(this.filled&&this.remaining){const s=(e.timestamp-this.timestamp)/this.granularity,a=Math.ceil(this.stacks[0]*(1-s)),h=this.remaining-a;this.remaining=a,this.live-=h}this.addData(t)}appendStack(e){e||(e=Date.now()),(!this.stacks.length||this.stacks[this.stacks.length-1])&&(this.stacks.push(0),this.timeouts.push(setTimeout(this.shiftStack.bind(this),this.window))),this.timestamp=e,!this.filled&&this.stacks.length===this.window/this.granularity&&(this.filled=!0)}shiftStack(){this.timeouts.shift(),this.stacks.shift()&&(this.remaining&&(this.live-=this.remaining),this.remaining=this.stacks[0])}addData(e){this.stacks[this.stacks.length-1]+=e,this.live+=e}getValue(){return this.live}createSerie(e){if(this.serie)return;const t="add"+(this.type.charAt(0).toUpperCase()+this.type.slice(1))+"Series",s=Object.assign({},I[this.type],{priceScaleId:this.name,title:this.name,priceLineVisible:!1,lineWidth:1,scaleMargins:{top:.05,bottom:.05},...this.getColorOptions()});this.serie=e[t](s)}updateSerie(){const e=this.getValue();if(!this.serie||!this.timestamp||this.type==="histogram"&&!e)return;const t={time:this.timestamp/1e3,value:e};typeof this.color=="function"&&(t.color=this.color(e)),this.serie.update(t)}getColorOptions(){if(typeof this.color=="function")return{};if(this.type==="area"){let e,t,s;this.color.indexOf("#")===0?[e,t,s]=f(this.color):[e,t,s]=k(this.color);const a=`rgba(${e},${t},${s}, .4)`,h=`rgba(${e},${t},${s}, 0)`;return{topColor:a,bottomColor:h,lineColor:this.color}}else return{color:this.color}}parseColor(e){return/rgba?\(|#/.test(e)?e:function(){return new Function("value",'"use strict"; return '+e)}()}updateColor(e){this.serie&&(this.color=this.parseColor(e),typeof e=="string"&&this.serie.applyOptions(this.getColorOptions()))}removeIndicator(e){this.serie&&(e.removeSeries(this.serie),delete this.serie)}}var N=Object.defineProperty,R=Object.getOwnPropertyDescriptor,x=(r,e,t,s)=>{for(var a=s>1?void 0:s?R(e,t):e,h=r.length-1,n;h>=0;h--)(n=r[h])&&(a=(s?n(e,t,a):n(a))||a);return s&&a&&N(e,t,a),a};let o=class extends m($){constructor(){super(...arguments);i(this,"data",{});i(this,"$refs");i(this,"_refreshChartDimensionsTimeout");i(this,"_chart");i(this,"_buckets",{});i(this,"_feed",null)}get enableChart(){return this.$store.state[this.paneId].enableChart}get buckets(){return this.$store.state[this.paneId].buckets}created(){this._onStoreMutation=this.$store.subscribe(t=>{switch(t.type){case"settings/SET_TEXT_COLOR":this._chart&&t.payload&&this._chart.applyOptions(u(this.paneId));break;case"settings/SET_CHART_THEME":this._chart&&this._chart.applyOptions(u(this.paneId));break;case"panes/SET_PANE_MARKETS":case this.paneId+"/SET_WINDOW":if(t.payload.id&&t.payload.id!==this.paneId)break;this.prepareBuckets();break;case this.paneId+"/SET_BUCKET_COLOR":this.recolorBucket(t.payload.id,t.payload.value);break;case this.paneId+"/SET_BUCKET_TYPE":this._chart&&this.reloadBucketSerie(t.payload.id,t.payload.value);break;case this.paneId+"/TOGGLE_CHART":t.payload?this.createChart():this.removeChart();break;case this.paneId+"/TOGGLE_BUCKET":t.payload.value?this.createBucket(this.buckets[t.payload.id]):this.removeBucket(t.payload.id);break;case"panes/SET_PANE_ZOOM":t.payload.id===this.paneId&&this.updateFontSize();break;case this.paneId+"/REMOVE_BUCKET":this.removeBucket(t.payload);break;case this.paneId+"/SET_BUCKET_WINDOW":case this.paneId+"/SET_BUCKET_INPUT":case this.paneId+"/SET_BUCKET_PRECISION":this.refreshBucket(t.payload.id);break;case this.paneId+"/RENAME_BUCKET":this.refreshBucketName(t.payload);break}}),this.prepareBuckets()}mounted(){this.enableChart&&this.createChart()}beforeDestroy(){this._feed&&c.off(this._feed,this.onVolume),this.clearBuckets(),this.removeChart(),this._chart=null}async createChart(){await this.$nextTick();const t=E(O,this.paneId);this._chart=w(this.$refs.chart,t);for(const s in this._buckets)this._buckets[s].createSerie(this._chart);this.refreshChartDimensions(0)}updateFontSize(){this._chart&&this._chart.applyOptions({layout:{fontSize:B(this.paneId)}})}removeChart(){if(this._chart){for(const t in this._buckets)this._buckets[t].removeIndicator(this._chart);this._chart.remove(),this._chart=null}}async refreshChartDimensions(t=500){this.enableChart&&(clearTimeout(this._refreshChartDimensionsTimeout),this._refreshChartDimensionsTimeout=setTimeout(()=>{this._chart&&this._chart.resize(this.$el.clientWidth,this.$el.clientHeight)},t))}prepareBuckets(){this._feed&&(console.debug(`[stats/${this.paneId}] unsubscribe from feed`,this._feed),c.off(this._feed,this.onVolume)),this.clearBuckets();for(const t in this.buckets)this.createBucket(this.buckets[t]);this._feed="bucket-"+b(this.pane.markets),console.debug(`[stats/${this.paneId}] subscribe to feed`,this._feed),this._feed.length?c.on(this._feed,this.onVolume):console.debug(`[stats/${this.paneId}] error feed empty...`)}onVolume(t){for(const s in this._buckets){if(this._buckets[s].onStats(t),this._buckets[s].stacks.length){const a=this._buckets[s].getValue();this.$set(this.data[s],"value",g(a,this._buckets[s].precision))}this._chart&&this._buckets[s].updateSerie()}}clearBuckets(){for(const t in this._buckets)this.removeBucket(t);this._buckets={}}removeBucket(t){this._buckets[t]&&(this._buckets[t].unbind(),this._chart&&this._buckets[t].removeIndicator(this._chart),this.$delete(this.data,t),delete this._buckets[t])}refreshBucket(t){const s=this.buckets[t];s&&(this.removeBucket(t),this.createBucket(s))}recolorBucket(t,s){this._buckets[t]&&(this._buckets[t].updateColor(s),this.$set(this.data[t],"color",s))}reloadBucketSerie(t,s){this._buckets[t]&&(s&&(this._buckets[t].type=s),this._buckets[t].removeIndicator(this._chart),this._buckets[t].createSerie(this._chart))}createBucket(t){if(t.enabled&&typeof this.data[t.id]>"u"){const s=new P(t.input,t,this.paneId);this._chart&&s.createSerie(this._chart),this._buckets[t.id]=s,this.$set(this.data,s.id,{value:0,name:s.name,color:s.color})}}refreshBucketName({id:t,name:s}){const a=this._buckets[t];a.name=s,this.$set(this.data[t],"name",s)}editStat(t){C.open(v,{paneId:this.paneId,bucketId:t})}onResize(){this.refreshChartDimensions()}};o=x([y({components:{PaneHeader:D},name:"Stats"})],o);var A=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"pane-stats"},[t("pane-header",{attrs:{paneId:e.paneId,settings:()=>T(()=>import("./StatsDialog.5c4cb14.js"),["StatsDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","paneDialogMixin.5c4cb14.js"])}}),t("ul",{staticClass:"stats-buckets"},e._l(e.data,function(s,a){return t("li",{key:a,staticClass:"stat-bucket",on:{click:function(h){return e.editStat(a)}}},[t("div",{staticClass:"stat-bucket__name"},[e._v(e._s(s.name))]),t("div",{staticClass:"stat-bucket__value"},[e._v(e._s(s.value))])])}),0),e.enableChart?t("div",{ref:"chart",staticClass:"stats-chart"}):e._e()],1)},M=[],U=S(o,A,M,!1,null,null,null,null);const H=U.exports;export{H as default};

var P=Object.defineProperty;var x=(i,t,e)=>t in i?P(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var d=(i,t,e)=>(x(i,typeof t!="symbol"?t+"":t,e),e);import{n as c,C as $,V as E,x as D,u as k,y as p,w as n,d as o,z as w,A as O,B as _,k as v,L as A,D as y,E as U,F as T,_ as f,h as R,a as j}from"./index.5c4cb14.js";import{T as L,a as N}from"./Tab.5c4cb14.js";const S={props:{value:{type:String,default:""}}};var B=function(){var t=this,e=t._self._c;return e("div",{staticClass:"search-bar form-control"},[e("input",{directives:[{name:"autofocus",rawName:"v-autofocus"}],staticClass:"search-bar__input form-control w-100",attrs:{type:"text",placeholder:"Search"},domProps:{value:t.value},on:{input:function(a){return t.$emit("input",a.currentTarget.value)}}}),t._t("default")],2)},F=[],q=c(S,B,F,!1,null,"da6a250e",null,null);const I=q.exports;var H=Object.defineProperty,W=Object.getOwnPropertyDescriptor,V=(i,t,e,a)=>{for(var s=a>1?void 0:a?W(t,e):t,r=i.length-1,u;r>=0;r--)(u=i[r])&&(s=(a?u(t,e,s):u(s))||s);return a&&s&&H(t,e,s),s};const l={originalWidth:500,originalHeight:100,displayWidth:300,displayHeight:100};let g=class extends E{constructor(){super(...arguments);d(this,"previewCanvasElement");d(this,"previewImageElement");d(this,"previewObjectUrl");d(this,"currentPreviewId");d(this,"previewCtx")}mounted(){this.mountPreview()}beforeDestroy(){document.getElementById("app").removeChild(this.previewCanvasElement)}mountPreview(){const t=window.devicePixelRatio||1;this.previewCanvasElement=document.createElement("canvas"),this.previewCanvasElement.width=l.displayWidth*t,this.previewCanvasElement.height=l.displayHeight*t,this.previewCanvasElement.style.width=`${l.displayWidth}px`,this.previewCanvasElement.style.height=`${l.displayHeight}px`,this.previewCanvasElement.style.top="-1rem",this.previewCanvasElement.style.left="0",this.previewCanvasElement.style.position="absolute",this.previewCanvasElement.style.pointerEvents="none",this.previewCanvasElement.style.zIndex="11",this.previewCanvasElement.style.borderRadius="0.75rem",document.getElementById("app").appendChild(this.previewCanvasElement),this.previewCtx=this.previewCanvasElement.getContext("2d")}async showPreview(t){if(!D()){if(!t.preview&&(t.imagePath&&(t.preview=await fetch(`https://lib.aggr.trade/${t.imagePath}`).then(e=>{if(!e.ok)throw t.imagePath=null,new Error("Network response was not ok");return e.blob()})),!t.preview)){this.clearPreview();return}t.id!==this.currentPreviewId&&(this.clearPreview(),this.currentPreviewId=t.id,t.preview instanceof Blob&&(this.previewObjectUrl=URL.createObjectURL(t.preview),this.previewImageElement=new Image,this.previewImageElement.src=this.previewObjectUrl,this.previewImageElement.addEventListener("load",this.onLoad)))}}onLoad(){const{width:t,height:e}=this.previewImageElement,a=window.devicePixelRatio||1;this.previewCtx.drawImage(this.previewImageElement,t-l.displayWidth*a,0,l.displayWidth*a,e,0,0,l.displayWidth*a,l.displayHeight*a),URL.revokeObjectURL(this.previewObjectUrl),this.previewObjectUrl=null,this.previewImageElement=null}movePreview(t){if(!this.previewCanvasElement)return;const e=k(t);this.previewCanvasElement.style.transform=`translate(${e.x-l.displayWidth/2}px, ${e.y-l.displayHeight}px)`}clearPreview(){this.previewCtx.clearRect(0,0,this.previewCanvasElement.width,this.previewCanvasElement.height),this.currentPreviewId=null,this.previewImageElement&&(this.previewImageElement.removeEventListener("load",this.onLoad),this.previewImageElement.src="",this.previewImageElement=null),this.previewObjectUrl&&(URL.revokeObjectURL(this.previewObjectUrl),this.previewObjectUrl=null)}};g=V([$],g);const z={name:"IndicatorTable",mixins:[g],props:{indicators:{type:Array,required:!0},query:{type:String,default:""},showDropdown:{type:Boolean,default:!1},showAuthor:{type:Boolean,default:!1},showEnabled:{type:Boolean,default:!1}},data(){return{ago:p,sortDirection:-1,sortProperty:"updatedAt"}},computed:{queryFilter(){return new RegExp(this.query.replace(/\W/,".*"),"i")},sortFunction(){return this.sortProperty==="description"?this.sortDirection>0?(i,t)=>(i.description||"").localeCompare(t.description||""):(i,t)=>(t.description||"").localeCompare(i.description||""):this.sortProperty==="name"?this.sortDirection>0?(i,t)=>(i.name||"").localeCompare(t.name||""):(i,t)=>(t.name||"").localeCompare(i.name||""):this.sortProperty==="createdAt"?this.sortDirection>0?(i,t)=>i.createdAt-t.createdAt:(i,t)=>t.createdAt-i.createdAt:this.sortProperty==="updatedAt"?this.sortDirection>0?(i,t)=>i.updatedAt-t.updatedAt:(i,t)=>t.updatedAt-i.updatedAt:this.sortProperty==="author"?this.sortDirection>0?(i,t)=>i.author-t.author:(i,t)=>t.author-i.author:(i,t)=>i.id.localeCompare(t.id)},filteredIndicators(){const i=this.sortFunction;return this.indicators.filter(t=>this.queryFilter.test(t.description)||this.queryFilter.test(t.name)).sort(i)}},methods:{toggleSort(i){i===this.sortProperty&&(this.sortDirection=this.sortDirection*-1),this.sortProperty=i}}};var J=function(){var t=this,e=t._self._c;return e("table",{staticClass:"table indicator-table__table"},[e("thead",[e("tr",[t.showEnabled?e("th",{staticClass:"table-min"}):t._e(),e("th",{staticClass:"table-sortable table-min",class:[t.sortProperty==="name"&&"table-sort--active"],on:{click:function(a){return t.toggleSort("name")}}},[e("span",[t._v("Name")]),t.sortProperty==="name"?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),e("th",{staticClass:"table-sortable w-100",on:{click:function(a){return t.toggleSort("description")}}},[e("span",[t._v("Description")]),t.sortProperty==="description"?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),t.showAuthor?e("th",{staticClass:"-dialog-min-m table-sortable text-right",on:{click:function(a){return t.toggleSort("author")}}},[e("span",[t._v("Author")]),t.sortProperty==="author"?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]):t._e(),e("th",{staticClass:"-dialog-min-m table-sortable text-right",on:{click:function(a){return t.toggleSort("updatedAt")}}},[e("span",[t._v("Date")]),t.sortProperty==="updatedAt"?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),t.showDropdown?e("th",{staticClass:"table-min"}):t._e()])]),t.filteredIndicators.length?e("tbody",{on:{mousemove:t.movePreview,mouseleave:t.clearPreview}},t._l(t.filteredIndicators,function(a){return e("tr",{key:a.id,staticClass:"-action",on:{click:function(s){return t.$emit("selected",a)},mouseenter:function(s){return t.showPreview(a)}}},[t.showEnabled?e("td",{staticClass:"table-action table-min",on:{click:function(s){return s.stopPropagation(),t.$emit("enabled",a)}}},[e("i",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"top"},expression:"{ placement: 'top' }"}],staticClass:"-lower",class:a.enabled?"icon-star-filled":"icon-star",attrs:{title:"Enable by default<br>on new charts"}})]):t._e(),e("td",{staticClass:"table-input text-color-base table-ellipsis",staticStyle:{"max-width":"200px"}},[t._v(" "+t._s((a.displayName||a.name).replace(/\{[\w_]+\}/g,""))+" ")]),e("td",{staticClass:"table-input table-ellipsis"},[e("span",{staticClass:"text-muted"},[t._v(t._s(a.description))])]),t.showAuthor?e("td",{staticClass:"table-input table-ellipsis"},[e("span",{staticClass:"text-muted"},[t._v(t._s(a.author))])]):t._e(),e("td",{staticClass:"-dialog-min-m table-input table-min text-right"},[e("span",[t._v(t._s(t.ago(a.updatedAt)))])]),t.showDropdown?e("td",{staticClass:"table-action -hover table-min",on:{click:function(s){return s.stopPropagation(),t.$emit("dropdown",[s,a])}}},[t._m(0,!0)]):t._e()])}),0):t._e()])},M=[function(){var i=this,t=i._self._c;return t("button",{staticClass:"btn -text -small"},[t("i",{staticClass:"icon-more"})])}],Z=c(z,J,M,!1,null,"a17c4c26",null,null);const C=Z.exports;const G={name:"InstalledIndicators",components:{IndicatorTable:C,SearchBar:I},data:()=>({indicators:[],query:"",selectedIndicator:null,dropdownTrigger:null}),async created(){await this.getIndicators()},methods:{async getIndicators(){const i=+new Date("2021-06-07T00:00:00Z");await this.$nextTick(),this.indicators=(await n.getIndicators()).map(t=>({...t,updatedAt:t.updatedAt||i}))},async removeIndicator(i=this.selectedIndicator){await o.confirm({message:`Delete indicator "${i.name}" ?<br><br><code class="-filled"><small>#${i.id}</small></code>`,html:!0})&&(n.deleteIndicator(i.id),this.indicators.splice(this.indicators.indexOf(i),1))},async selectIndicator(i=this.selectedIndicator){this.$emit("add",i)},async duplicateIndicator(i=this.selectedIndicator){w.importIndicator({type:"indicator",name:"indicator:"+i.name,data:i})},async downloadIndicator(i=this.selectedIndicator){await O({type:"indicator",name:"indicator:"+i.name,data:i},"indicator_"+i.id)},toggleDropdown([i,t]){i&&(!this.dropdownTrigger||this.selectedIndicator!==t)?(this.dropdownTrigger=i.currentTarget,this.selectedIndicator=t):(this.dropdownTrigger=null,this.selectedIndicator=null)},toggleEnabled(i){i.enabled=!i.enabled,n.saveIndicator(i,!0)}}};var K=function(){var t=this,e=t._self._c;return e("div",{staticClass:"installed-indicators"},[e("SearchBar",{model:{value:t.query,callback:function(a){t.query=a},expression:"query"}}),e("IndicatorTable",{staticClass:"table--inset",attrs:{indicators:t.indicators,query:t.query,"show-enabled":"","show-dropdown":""},on:{selected:function(a){return t.$emit("selected",a)},enabled:t.toggleEnabled,dropdown:t.toggleDropdown}}),e("dropdown",{model:{value:t.dropdownTrigger,callback:function(a){t.dropdownTrigger=a},expression:"dropdownTrigger"}},[e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(a){return t.selectIndicator()}}},[e("i",{staticClass:"icon-plus"}),e("span",[t._v("Add to chart")])]),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(a){return t.duplicateIndicator()}}},[e("i",{staticClass:"icon-copy-paste"}),e("span",[t._v("Duplicate")])]),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(a){return t.downloadIndicator()}}},[e("i",{staticClass:"icon-download"}),e("span",[t._v("Download")])]),e("div",{staticClass:"dropdown-divider"}),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(a){return t.removeIndicator()}}},[e("i",{staticClass:"icon-trash"}),e("span",[t._v("Remove")])])])],1)},Q=[],X=c(G,K,Q,!1,null,"4e848f98",null,null);const Y=X.exports;const tt={name:"CommunityIndicatorsIncentive",components:{Btn:_},data:()=>({isDismissed:v.hasDismissed("community-indicators-incentive"),repoUrl:"https://github.com/Tucsky/aggr-lib"}),methods:{dismiss(){v.dismiss("community-indicators-incentive"),this.isDismissed=!0}}};var et=function(){var t=this,e=t._self._c;return e("div",{staticClass:"community-indicators-incentive",class:[t.isDismissed&&"community-indicators-incentive--dismissed"]},[e("div",{staticClass:"community-indicators-incentive__wrapper"},[e("div",{staticClass:"community-indicators-incentive__head"},[e("h3",{staticClass:"community-indicators-incentive__title"},[t._v(" Introducing Aggr Library ")]),t.isDismissed?t._e():e("Btn",{staticClass:"community-indicators-incentive__close -small -text",on:{click:t.dismiss}},[e("i",{staticClass:"icon-cross"})])],1),e("p",{staticClass:"community-indicators-incentive__subtitle"},[t._v(" Indicators that are uploaded to "),e("a",{attrs:{href:t.repoUrl,target:"_blank"}},[t._v("aggr-lib")]),t._v(" will automatically appear in this list. ")]),e("Btn",{staticClass:"community-indicators-incentive__cta -theme",attrs:{href:t.repoUrl,target:"_blank"}},[e("i",{staticClass:"icon-github mr8"}),t._v(" Start contributing ")])],1)])},it=[],at=c(tt,et,it,!1,null,"f3edf8ba",null,null);const st=at.exports;let m=[];const rt={name:"CommunityIndicators",components:{SearchBar:I,IndicatorTable:C,LibraryIncentive:st,Loader:A,Btn:_},data:()=>({indicators:m,query:"",selectedIndicator:null,dropdownTrigger:null,isLoading:!1}),async created(){m.length||await this.getIndicators()},methods:{async getIndicators(){this.isLoading=!0;try{m=await(await fetch("https://lib.aggr.trade/library/indicators")).json(),this.indicators=m}catch(i){console.error(i),this.$store.dispatch("app/showNotice",{type:"error",title:"Failed to fetch indicators"})}finally{this.isLoading=!1}}}};var nt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"community-indicators"},[t.isLoading?e("Loader",{staticClass:"community-indicators__loader"}):t._e(),e("transition",{attrs:{name:"transition-height-scale"}},[t.isLoading?t._e():e("div",{staticClass:"community-indicators__wrapper"},[e("LibraryIncentive"),e("SearchBar",{staticClass:"community-indicators__search-bar",model:{value:t.query,callback:function(a){t.query=a},expression:"query"}},[e("Btn",{staticClass:"-text -small",on:{click:t.getIndicators}},[e("i",{staticClass:"icon-refresh"})])],1),e("IndicatorTable",{staticClass:"table--inset",attrs:{indicators:t.indicators,query:t.query,"show-author":""},on:{selected:function(a){return t.$emit("selected",a)}}})],1)])],1)},ot=[],lt=c(rt,nt,ot,!1,null,"26d8a1e7",null,null);const ct=lt.exports;const dt={name:"EditResourceDialog",components:{Btn:_},props:{item:{type:Object,required:!0},ids:{type:Array,required:!0}},mixins:[y],data(){return{dialogOpened:!1,name:this.item.name||"",description:this.item.description||"",updateId:!1,imageObjectUrl:null,newImagePreview:null,hasDeletedPreview:!1}},computed:{displayId(){const i=this.item.id;return i?i.length<=16?i:i.slice(0,6)+".."+i.substr(-6):"no id"},newId(){return U(T(this.name),this.idsExceptCurrent)},idsExceptCurrent(){return this.ids.filter(i=>i!==this.item.id)},hasCustomPreview(){return this.hasDeletedPreview?!1:!!(this.newImagePreview||this.item.preview instanceof File)},previewName(){return this.hasCustomPreview?this.item.id+".png":"Browse"}},mounted(){this.loadPreview(),this.show()},beforeDestroy(){this.clearPreview()},methods:{show(){this.dialogOpened=!0},hide(){this.dialogOpened=!1},onHide(){this.close()},submit(){this.output={...this.item,name:this.name,displayName:this.name,description:this.description},this.newImagePreview?this.output.preview=this.newImagePreview:this.hasDeletedPreview&&(this.output.preview=null),this.updateId&&(this.output.id=this.newId),this.hide()},loadPreview(){this.clearPreview();const i=this.newImagePreview||this.item.preview;(i instanceof File||i instanceof Blob)&&(this.imageObjectUrl=URL.createObjectURL(i))},clearPreview(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},handlePreviewFile(){const i=event.target.files[0];i&&(this.newImagePreview=i,this.hasDeletedPreview=!1,this.loadPreview())},removePreview(){this.newImagePreview&&(this.newImagePreview=null),this.clearPreview(),this.hasDeletedPreview=!0}}};var pt=function(){var t=this,e=t._self._c;return e("form",{on:{submit:function(a){return a.preventDefault(),t.submit.apply(null,arguments)}}},[e("transition",{attrs:{name:"dialog",duration:500},on:{"after-leave":t.onHide}},[t.dialogOpened?e("Dialog",{staticClass:"edit-resource-dialog",on:{clickOutside:t.hide},scopedSlots:t._u([{key:"header",fn:function(){return[e("div",{staticClass:"d-flex"},[e("div",{staticClass:"dialog__title"},[t._v("Edit "+t._s(t.item.name))]),e("small",[e("code",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"-filled -center ml4",attrs:{title:`ID: ${t.item.id}`}},[t._v(" "+t._s(t.displayId)+" ")])])])]},proxy:!0},{key:"footer",fn:function(){return[e("Btn",{staticClass:"btn -text",attrs:{type:"button"},on:{click:t.hide}},[t._v("Cancel")]),e("Btn",{staticClass:"btn -green ml8 -large",attrs:{type:"submit"}},[e("i",{staticClass:"icon-check mr8"}),t._v(" Save ")])]},proxy:!0}],null,!1,458649603)},[e("div",{staticClass:"d-flex -gap16 mb16"},[e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v("Name")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.name,expression:"name"}],staticClass:"form-control w-100",attrs:{id:"label",type:"text",required:""},domProps:{value:t.name},on:{input:function(a){a.target.composing||(t.name=a.target.value)}}})]),e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v(" ")]),e("label",{staticClass:"checkbox-control"},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.updateId,expression:"updateId"}],staticClass:"form-control",attrs:{type:"checkbox"},domProps:{checked:Array.isArray(t.updateId)?t._i(t.updateId,null)>-1:t.updateId},on:{change:function(a){var s=t.updateId,r=a.target,u=!!r.checked;if(Array.isArray(s)){var b=null,h=t._i(s,b);r.checked?h<0&&(t.updateId=s.concat([b])):h>-1&&(t.updateId=s.slice(0,h).concat(s.slice(h+1)))}else t.updateId=u}}}),e("div",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"mr8",attrs:{title:"Get a new ID"}}),e("i",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"icon-info",attrs:{title:"IDs are unique in the library !"}})])])]),t.updateId&&t.item.id!==t.newId?e("p",[e("i",{staticClass:"icon-info"}),t._v(" ID change "),e("code",{staticClass:"-filled"},[t._v(t._s(t.item.id))]),t._v(" → "),e("code",{staticClass:"-filled"},[t._v(t._s(t.newId))])]):t._e(),e("div",{staticClass:"form-group mb16"},[e("label",{attrs:{for:"label"}},[t._v("Description")]),e("textarea",{directives:[{name:"model",rawName:"v-model",value:t.description,expression:"description"}],staticClass:"form-control w-100",domProps:{value:t.description},on:{input:function(a){a.target.composing||(t.description=a.target.value)}}})]),e("div",{staticClass:"d-flex -gap16"},[e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v("Preview")]),e("button",{staticClass:"btn -file -blue -cases"},[e("i",{staticClass:"icon-upload mr8"}),t._v(" "+t._s(t.previewName)+" "),t.hasCustomPreview?e("i",{staticClass:"icon-cross mr8 btn__suffix",on:{click:function(a){return a.stopPropagation(),a.preventDefault(),t.removePreview.apply(null,arguments)}}}):t._e(),e("input",{staticClass:"input-file",attrs:{type:"file",accept:"image/*"},on:{change:t.handlePreviewFile}})])]),e("div",{staticClass:"edit-resource-dialog__preview"},[t.imageObjectUrl?e("img",{attrs:{src:t.imageObjectUrl}}):t._e()])])]):t._e()],1)],1)},ut=[],ht=c(dt,pt,ut,!1,null,"71090d9c",null,null);const mt=ht.exports;async function _t(i){if(!(!v.hasDismissed("publish-onboarding")&&!await o.openAsPromise((await f(()=>import("./PublishOnboarding.5c4cb14.js"),["PublishOnboarding.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","PublishOnboarding.5c4cb14.css"])).default)))return o.openAsPromise((await f(()=>import("./PublishResourceDialog.5c4cb14.js"),["PublishResourceDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","Tab.5c4cb14.js","Tab.5c4cb14.css","PublishResourceDialog.5c4cb14.css"])).default,{item:i})}async function kt(i){if(!i.preview){o.confirm({cancel:!1,message:"Indicator's preview is mandatory for publishing. Just save it once it's added on a chart to generate the thumbnail !"});return}let t=localStorage.getItem("author");if(!t){if(t=await o.prompt({action:"Name yourself",label:"Username"}),!t)return;localStorage.setItem("author",t)}const e={...i,preview:void 0,author:t},a=new FormData;try{const r=new Blob([JSON.stringify(e)],{type:"application/json"});a.append("jsonFile",r,"indicator.json"),a.append("pngFile",i.preview,"indicator.png")}catch{throw new Error("Failed to create payload")}const s=await fetch("https://lib.aggr.trade/publish/indicators",{method:"POST",body:a});if(!s.ok)throw new Error("Failed to publish");try{const{url:r}=await s.json();return r}catch{throw new Error("Failed to parse server response")}}const vt={props:{indicator:{type:Object,required:!0}},components:{Btn:_},data(){return{opened:!1,isInstalling:!1,isPublishing:!1,dropdownTrigger:null,imageObjectUrl:null,dateIndex:0,communityTabEnabled:!0}},computed:{isInstalled(){return!!this.indicator.script},image(){return this.imageObjectUrl?this.imageObjectUrl:this.indicator.imagePath?`https://lib.aggr.trade/${this.indicator.imagePath}`:null},createdAt(){return this.indicator.createdAt?`${p(this.indicator.createdAt)} ago`:null},updatedAt(){return this.indicator.updatedAt?`${p(this.indicator.updatedAt)} ago`:null},dates(){const i=[];return this.indicator.updatedAt&&i.push({title:"Updated at",label:"Updated",value:`${p(this.indicator.updatedAt)} ago`}),this.indicator.createdAt&&i.push({title:"Created at",label:"Created",value:`${p(this.indicator.createdAt)} ago`}),i},prId(){return this.indicator.pr?this.indicator.pr.split("/").pop():null},authorUrl(){return`https://github.com/Tucsky/aggr-lib/tree/main/indicators/${this.indicator.author}`}},watch:{indicator:{immediate:!0,handler(){this.loadPreview(),this.isInstalling&&this.addToChart()}}},mounted(){this.opened=!0},beforeDestroy(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},methods:{close(){this.opened=!1},toggleDropdown(i){i&&!this.dropdownTrigger?this.dropdownTrigger=i.currentTarget:this.dropdownTrigger=null},onBackdropClick(i){i.target===i.currentTarget&&this.close()},loadPreview(){this.clearPreview();const i=this.indicator.preview;this.isInstalled&&(i instanceof Blob||i instanceof File)&&(this.imageObjectUrl=URL.createObjectURL(i))},clearPreview(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},async installIndicator(){if(!this.isInstalled){this.isInstalling=!0;try{const i=await(await fetch(`https://lib.aggr.trade/${this.indicator.jsonPath}`)).json();if(!i.data)throw new Error("invalid payload");this.image&&(i.data.preview=await(await fetch(this.image)).blob()),await w.importIndicator(i)}catch(i){console.error(i),this.$store.dispatch("app/showNotice",{type:"error",title:"Failed to fetch indicator"})}finally{this.isInstalling=!1}}},addToChart(){this.$emit("add",this.indicator)},async editName(){if(!this.isInstalled)return;const i=await o.prompt({label:"Name",action:"Rename",placeholder:this.indicator.name});i&&i!==this.indicator.name&&(await n.saveIndicator({...this.indicator,name:i,displayName:i},!0),this.$emit("reload"))},async editDescription(){if(!this.isInstalled)return;const i=await o.prompt({label:"Description",action:"Edit",placeholder:this.indicator.description,input:this.indicator.description,tag:"textarea"});i&&i!==this.indicator.description&&(await n.saveIndicator({...this.indicator,description:i},!0),this.$emit("reload"))},async publish(){if(this.isInstalled)try{const i=await _t(this.indicator);i&&(await n.saveIndicator({...this.indicator,pr:i},!0),this.$emit("reload"))}catch(i){console.error(i),this.$store.dispatch("app/showNotice",{type:"error",title:"Failed to publish indicator"})}},async edit(){const i=await o.openAsPromise(mt,{item:this.indicator,ids:await n.getIndicatorsIds()});i&&(i.id!==this.indicator.id&&await n.deleteIndicator(this.indicator.id),await n.saveIndicator(i,!0),this.$emit("reload",i.id))}}};var ft=function(){var t=this,e=t._self._c;return e("transition",{attrs:{name:"indicator-detail"},on:{"after-leave":function(a){return t.$emit("close")}}},[t.opened?e("div",{staticClass:"indicator-detail",on:{click:t.onBackdropClick}},[e("div",{staticClass:"indicator-detail__wrapper hide-scrollbar"},[e("div",{staticClass:"indicator-detail__preview"},[e("Btn",{staticClass:"indicator-detail__close -text",on:{click:t.close}},[e("i",{staticClass:"icon-cross"})]),e("code",{staticClass:"indicator-detail__id -filled ml8"},[e("small",[t._v("#"+t._s(t.indicator.id))])]),t.image?e("img",{attrs:{src:t.image}}):t._e()],1),e("div",{staticClass:"indicator-detail__content"},[e("div",{staticClass:"indicator-detail__head"},[e("div",{staticClass:"indicator-detail__name"},[e("div",{on:{dblclick:t.editName}},[t._v(" "+t._s(t.indicator.displayName||t.indicator.name)+" ")]),t.isInstalled?e("Btn",{staticClass:"-text -small indicator-detail__toggle",on:{click:t.toggleDropdown}},[e("i",{staticClass:"icon-more"})]):t._e()],1),e("small",{staticClass:"indicator-detail__subtitle"},[t.indicator.author?e("span",[t._v(" by "),e("a",{attrs:{href:t.authorUrl,target:"_blank"}},[t._v(t._s(t.indicator.author))])]):t._e(),e("span",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"top",distance:24},expression:"{ placement: 'top', distance: 24 }"}],attrs:{title:t.dates[t.dateIndex].title},on:{click:function(a){t.dateIndex=(t.dateIndex+1)%t.dates.length}}},[t._v(" "+t._s(t.dates[t.dateIndex].value)+" ")])])]),e("div",{staticClass:"indicator-detail__detail"},[e("p",{staticClass:"indicator-detail__description",on:{dblclick:t.editDescription}},[t._v(" "+t._s(t.indicator.description||"Add description")+" ")]),e("ul",{staticClass:"indicator-detail__metadatas"},[t.indicator.pr?e("li",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"right",distance:24},expression:"{ placement: 'right', distance: 24 }"}],attrs:{title:"Publish request"}},[e("span",[t._v("Publish")]),e("a",{staticClass:"indicator-detail__metadatas-value",attrs:{target:"_blank",href:t.indicator.pr}},[t._v(" #"+t._s(t.prId)+" ")])]):t._e()])])]),e("div",{staticClass:"indicator-detail__footer"},[t.isInstalled?e("Btn",{on:{click:t.addToChart}},[e("i",{staticClass:"icon-plus mr4"}),t._v(" Add ")]):e("Btn",{attrs:{loading:t.isInstalling},on:{click:t.installIndicator}},[t._v("Install")])],1),e("dropdown",{model:{value:t.dropdownTrigger,callback:function(a){t.dropdownTrigger=a},expression:"dropdownTrigger"}},[t.communityTabEnabled?e("btn",{staticClass:"dropdown-item -cases",attrs:{loading:t.isPublishing},on:{click:t.publish}},[e("i",{staticClass:"icon-external-link-square-alt"}),e("span",[t._v("Publish")])]):t._e(),e("Btn",{staticClass:"dropdown-item -cases",on:{click:t.edit}},[e("i",{staticClass:"icon-edit"}),e("span",[t._v("Edit")])])],1)],1)]):t._e()])},gt=[],wt=c(vt,ft,gt,!1,null,"b0da706e",null,null);const bt=wt.exports;const yt={mixins:[y],components:{InstalledIndicators:Y,CommunityIndicators:ct,IndicatorDetail:bt,TransitionHeight:R,Dialog:j,Tabs:L,Tab:N},data:()=>({name:"",tab:"installed",selection:null,communityTabEnabled:!0,ago:p}),computed:{isBack(){return this.tab==="installed"},paneId(){if(this.$store.state.app.focusedPaneId&&this.$store.state.panes.panes[this.$store.state.app.focusedPaneId].type==="chart")return this.$store.state.app.focusedPaneId;for(const i in this.$store.state.panes.panes)if(this.$store.state.panes.panes[i].type==="chart")return i;return null}},methods:{async handleFile(i){try{const t=await w.getJSON(i.target.files[0]);if(!t.data)throw new Error("indicator is empty");if(t.type!=="indicator")throw new Error("not an indicator");this.createIndicator({name:t.name.split(":").slice(1).join(":"),script:t.data.script||"",options:t.data.options||{}})}catch(t){this.$store.dispatch("app/showNotice",{title:t.message,type:"error"})}},showNoPaneId(){o.confirm({title:"No chart",message:"Add a chart to continue",cancel:null,ok:"Ok"})},async addToChart(i,t=!1){this.$store.dispatch(this.paneId+"/addIndicator",await n.incrementIndicatorUsage(i.id)),t&&this.close()},async createIndicator(i={}){if(!this.paneId)return this.showNoPaneId();i.name||(i.name="Untitled"),i.libraryId||(i.libraryId=null),o.openIndicator(this.paneId,await this.$store.dispatch(this.paneId+"/addIndicator",i)),this.close()},async promptCreateIndicator(){if(!this.paneId)return this.showNoPaneId();const i=await o.openAsPromise((await f(()=>import("./CreateIndicatorDialog.5c4cb14.js"),["CreateIndicatorDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","options.5c4cb14.js"])).default,{paneId:this.paneId});i&&this.createIndicator(i)},setSelection(i){this.selection=i,this.$refs.installed&&this.$refs.installed.getIndicators()},async reloadSelection(i){this.selection&&this.setSelection(await n.getIndicator(i||this.selection.id))}}};var It=function(){var t=this,e=t._self._c;return e("Dialog",{staticClass:"indicator-library-dialog",attrs:{size:"medium",contrasted:""},on:{clickOutside:t.close},scopedSlots:t._u([{key:"header",fn:function(){return[e("div",{staticClass:"d-flex"},[e("div",{staticClass:"dialog__title indicator-dialog__title -center"},[e("div",[t._v("Indicators")])])])]},proxy:!0},{key:"subheader",fn:function(){return[e("tabs",{model:{value:t.tab,callback:function(a){t.tab=a},expression:"tab"}},[e("tab",{attrs:{name:"installed"}},[t._v(" Installed ")]),t.communityTabEnabled?e("tab",{attrs:{name:"community"}},[t._v(" Community "),e("span",{staticClass:"badge -red ml8"},[t._v("new")])]):t._e()],1)]},proxy:!0},{key:"footer",fn:function(){return[e("button",{staticClass:"btn -theme -large -cases -file"},[e("input",{ref:"importButton",staticClass:"input-file",attrs:{type:"file"},on:{change:t.handleFile}}),t._v(" Import "),e("i",{staticClass:"icon-upload ml8"})]),e("button",{staticClass:"mlauto btn -green -large -cases",on:{click:t.promptCreateIndicator}},[t._v(" Create "),e("i",{staticClass:"icon-plus ml8"})])]},proxy:!0}])},[e("TransitionHeight",{staticClass:"indicator-library-dialog__stepper",attrs:{stepper:"",name:`slide-fade-${t.isBack?"left":"right"}`,duration:500}},[t.tab==="installed"?e("InstalledIndicators",{key:"installed",ref:"installed",attrs:{"pane-id":t.paneId},on:{close:t.close,add:t.addToChart,selected:function(a){t.selection=a}}}):t.tab==="community"?e("CommunityIndicators",{key:"community",attrs:{"pane-id":t.paneId},on:{close:t.close,selected:function(a){t.selection=a}}}):t._e()],1),t.selection?e("IndicatorDetail",{attrs:{indicator:t.selection},on:{close:function(a){t.selection=null},add:function(a){return t.addToChart(a,!0)},reload:t.reloadSelection}}):t._e()],1)},Ct=[],Pt=c(yt,It,Ct,!1,null,"b6b98a4b",null,null);const xt=Pt.exports,Ot=Object.freeze(Object.defineProperty({__proto__:null,default:xt},Symbol.toStringTag,{value:"Module"}));export{Ot as I,kt as u};

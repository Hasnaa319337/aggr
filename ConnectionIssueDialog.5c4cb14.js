import{n as c,h as l,L as d,D as h,j as o,k as u}from"./index.5c4cb14.js";const p={name:"ConnectionIssueDialog",components:{TransitionHeight:l,Loader:d},props:{exchangeId:{type:String},restrictedUrl:{type:String}},mixins:[h],data(){return{data:null,proxyUrl:"",isTesting:!1,selectedAction:null,isBack:!1,stepIndex:0,dialogOpened:!1,sections:[]}},computed:{currentWsProxyUrl(){return this.$store.state.settings.wsProxyUrl},valid(){return/wss?:\/\/.{3,}/.test(this.proxyUrl)},computedUrl(){const[s,e]=this.proxyUrl.split("?"),t=s.replace(/([^/])$/,"$1/");return e&&e.length?t+"?"+e+"&url=":t+"?url="},testUrl(){return this.computedUrl+this.restrictedUrl},contextId(){return this.exchangeId+this.restrictedUrl}},watch:{stepIndex(s,e){this.isBack=s<e,s===2&&this.test()}},created(){this.currentWsProxyUrl&&(this.proxyUrl=this.currentWsProxyUrl.replace(/(&|\?)url=/g,"")),o.on("connection",this.onSubscribed)},beforeDestroy(){o.off("connection",this.onSubscribed)},mounted(){this.data||this.show()},methods:{onSubscribed(s){(s.url===this.restrictedUrl||s.url===this.testUrl)&&this.hide()},show(){this.dialogOpened=!0},hide(s=null){this.isTesting||(this.data=s,this.dialogOpened=!1)},onShow(){},onHide(){this.close(this.data)},submit(){this.valid&&this.hide()},dismiss(){this.hide(),u.dismiss(this.contextId,864e5)},next(){if(this.stepIndex===1&&!this.valid){this.$refs.input.focus();return}this.stepIndex=Math.min(2,this.stepIndex+1)},prev(){this.stepIndex=Math.max(0,this.stepIndex-1)},async disableExchange(){this.selectedAction="disable";try{await this.$store.dispatch("exchanges/toggleExchange",this.exchangeId),this.hide()}catch(s){this.$store.dispatch("app/showNotice",{title:s.message})}finally{this.selectedAction=null}},async refreshExchange(){this.selectedAction="disable";try{await this.$store.dispatch("exchanges/disconnect",this.exchangeId),await this.$store.dispatch("exchanges/connect",this.exchangeId),this.hide()}catch(s){this.$store.dispatch("app/showNotice",{title:s.message})}finally{this.selectedAction=null}},validate(){return!!this.valid},test(){if(!this.proxyUrl)return!1;this.isTesting=!0;const s=this.testUrl;return new Promise(e=>{const t=new WebSocket(s);let i,r,n;const a=()=>{t.removeEventListener("open",r),t.removeEventListener("error",n),t.removeEventListener("close",n),t.readyState<2&&t.close()};r=()=>{i=setTimeout(()=>{i=null,e(!0),a()},3e3)},n=()=>{i&&clearTimeout(i),setTimeout(()=>{e(!1),a()},1e3)},t.addEventListener("open",r),t.addEventListener("error",n),t.addEventListener("close",n)}).then(e=>(this.isTesting=!1,e?this.hide(this.computedUrl):(this.$store.dispatch("app/showNotice",{title:`Failed to open ws connection with ${s}`,type:"error"}),this.prev()),e))},deleteWsProxyUrl(){this.hide("")}}};var m=function(){var e=this,t=e._self._c;return t("transition",{attrs:{name:"dialog",duration:500},on:{"after-leave":e.onHide,"after-enter":e.onShow}},[e.dialogOpened?t("Dialog",{staticClass:"connection-issue-dialog",attrs:{resizable:!1},on:{clickOutside:e.hide},scopedSlots:e._u([{key:"header",fn:function(){return[t("div",[t("div",{staticClass:"dialog__title"},[t("i",{staticClass:"icon-warning -lower"}),e._v(" Connection issue ")])]),t("div",{staticClass:"column -center"})]},proxy:!0},{key:"footer",fn:function(){return[e.stepIndex?[e.stepIndex?t("button",{staticClass:"btn -text -large mrauto",attrs:{disabled:e.isTesting,type:"button"},on:{click:e.prev}},[e._v(" Back ")]):e._e()]:[t("button",{staticClass:"btn -text mrauto",attrs:{type:"button"},on:{click:e.dismiss}},[e._v(" Dismiss ")]),t("button",{staticClass:"btn -text ml8 -large",attrs:{type:"button"},on:{click:e.next}},[e._v(" Troubleshoot ")])]]},proxy:!0}],null,!1,107095997)},[t("form",{on:{submit:function(i){return i.preventDefault(),e.submit.apply(null,arguments)}}},[t("transition-height",{staticClass:"connection-issue-dialog__stepper",attrs:{stepper:"",name:`slide-fade-${e.isBack?"left":"right"}`,duration:500}},[e.stepIndex===0?t("div",{key:"step-0",staticClass:"connection-issue-dialog__step"},[t("p",{staticClass:"form-feedback mt0 mb0"},[e._v(" Can't connect to "+e._s(e.restrictedUrl)),t("i",{directives:[{name:"tippy",rawName:"v-tippy",value:{boundary:"window",distance:24},expression:"{ boundary: 'window', distance: 24 }"}],staticClass:"icon-info -lower ml4",attrs:{title:"Exchange API refused to connect<br>or blocked connection."}})])]):e._e(),e.stepIndex===1?t("div",{key:"step-1",staticClass:"connection-issue-dialog__step"},[t("p",{staticClass:"-inline mb0 mt0"},[e._v(" The exchange API is unreachable due to "),t("u",{directives:[{name:"tippy",rawName:"v-tippy"}],attrs:{title:"Beginning in late November 2022, Binance began declining API requests originating from US IP addresses."}},[e._v(" geo restriction ")]),e._v(" or something else. ")]),t("ol",{staticClass:"mb0"},[e.currentWsProxyUrl?t("li",[t("p",[e._v(" The current proxy URL might not be working"),t("br"),e._v(" Last used : "),t("code",[e._v(e._s(e.currentWsProxyUrl))])]),t("button",{staticClass:"btn -red mrauto -cases",attrs:{type:"button",disable:e.selectedAction},on:{click:e.deleteWsProxyUrl}},[t("i",{staticClass:"icon-eraser mr8"}),e._v(" Clear proxy URL ")])]):e._e(),t("li",[t("p",[e._v(" Disable all "+e._s(e.exchangeId)+"'s pairs so you won't see the issue anymore ")]),t("button",{staticClass:"btn -red -cases",attrs:{type:"button",disable:e.selectedAction},on:{click:e.disableExchange}},[t("i",{staticClass:"icon-cross mr8"}),e._v(" DisableÂ  "),t("span",[e._v(e._s(e.exchangeId))]),t("i",{staticClass:"ml4",class:"icon-"+e.exchangeId})])]),t("li",[t("p",[e._v("Use a VPN")]),t("button",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"btn -green -cases",attrs:{type:"button",disable:e.selectedAction,title:"Retry connection with exchange"},on:{click:e.refreshExchange}},[t("i",{staticClass:"icon-refresh mr8"}),e._v(" I enabled my VPN ")])])])]):e.stepIndex===2?t("div",{key:"step-3",staticClass:"connection-issue-dialog__step"},[t("p",{staticClass:"mx0 text-center text-muted"},[e._v("Connecting to")]),t("p",{staticClass:"mt0 text-center"},[t("code",[e._v(e._s(e.testUrl))])]),t("loader",{ref:"loader"}),t("p",{staticClass:"mb0 text-center text-muted"},[e._v("Please wait")])],1):e._e()])],1)]):e._e()],1)},g=[],x=c(p,m,g,!1,null,null,null,null);const f=x.exports;export{f as default};
